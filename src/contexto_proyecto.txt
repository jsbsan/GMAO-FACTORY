ESTRUCTURA DEL PROYECTO:
./
    app.py
    contexto_proyecto.txt
    database.py
    Empaquetador_de_Proyectos.py
    requirements.txt
    resumen.py
    utils.py
    templates/
        about.html
        base.html
        help.html
        login.html
        viewer.html
        activities/
            edit.html
            index.html
        calendar/
            index.html
        correctivos/
            edit.html
            index.html
        inventory/
            edit.html
            index.html
        print/
            activity.html
            all_activities.html
            all_correctivos.html
            all_inventory.html
            all_ots.html
            correctivo.html
            cronograma.html
            inventory.html
            ot.html
        resumen/
            index.html
        settings/
            edit_type.html
            index.html
        work_orders/
            cronograma.html
            index.html

==================================================
CONTENIDO DE LOS ARCHIVOS:
==================================================

--- INICIO ARCHIVO: app.py ---
import sqlite3
import base64
import datetime
from flask import Flask, render_template, request, redirect, url_for, flash, send_file, session
import json
import os
import shutil
from werkzeug.security import check_password_hash, generate_password_hash
import database as db
import utils
from resumen import resumen_bp
from waitress import serve

app = Flask(__name__)
app.secret_key = 'super_secret_key_mantenimiento_factory'
app.register_blueprint(resumen_bp, url_prefix='/resumen')

@app.template_filter('json_load')
def json_load_filter(s):
    return utils.json_load_filter(s)

# Context Processor para inyectar el nombre del mantenimiento en todas las vistas
@app.context_processor
def inject_maintenance_name():
    return dict(maintenance_name=utils.get_maintenance_name())

# ==========================================
# AUTENTICACIÓN
# ==========================================

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        conn = db.get_db_connection()
        user = conn.execute('SELECT * FROM usuarios WHERE username = ?', (username,)).fetchone()
        conn.close()
        if user and check_password_hash(user['password_hash'], password):
            session['user_id'] = user['id']
            session['username'] = user['username']
            session['rol'] = user['rol']
            session['perm_inventario'] = user['perm_inventario']
            session['perm_actividades'] = user['perm_actividades']
            session['perm_configuracion'] = user['perm_configuracion']
            utils.log_action(f"Inicio de sesión exitoso: {username}")
            return redirect(url_for('index'))
        else:
            flash('Usuario o contraseña incorrectos', 'danger')
    return render_template('login.html')

@app.route('/logout')
def logout():
    utils.log_action(f"Cierre de sesión: {session.get('username')}")
    session.clear()
    return redirect(url_for('login'))

@app.route('/')
@utils.login_required
def index():
    return redirect(url_for('resumen.index'))

# ==========================================
# INVENTARIO
# ==========================================

@app.route('/inventory')
@utils.login_required
def inventory():
    db.init_db()
    conn = db.get_db_connection()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    items = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    return render_template('inventory/index.html', items=items, tipos=tipos, active_page='inventario', system_date=utils.get_system_date())

@app.route('/inventory/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def add_inventory():
    try:
        images_list = []
        for f in request.files.getlist('images')[:5]:
             if f and utils.allowed_file_image(f.filename): images_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
        pdfs_list = []
        for f in request.files.getlist('pdfs')[:5]:
             if f and utils.allowed_file_pdf(f.filename): pdfs_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
        conn = db.get_db_connection()
        conn.execute('INSERT INTO inventario (nombre, tipo_id, descripcion, images, pdfs) VALUES (?, ?, ?, ?, ?)',
                     (request.form['nombre'], request.form['tipo_id'], request.form['descripcion'], json.dumps(images_list), json.dumps(pdfs_list)))
        conn.commit()
        conn.close()
        utils.log_action(f"Inventario añadido: {request.form['nombre']}")
        flash('Equipo añadido', 'success')
    except Exception as e: flash(f'Error: {e}', 'danger')
    return redirect(url_for('inventory'))

@app.route('/inventory/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_inventario')
def edit_inventory(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT * FROM inventario WHERE id=?', (id,)).fetchone()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    conn.close()
    if not item: return redirect(url_for('inventory'))
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    return render_template('inventory/edit.html', item=item, tipos=tipos, imgs=imgs, pdfs=pdfs, active_page='inventario', system_date=utils.get_system_date())

@app.route('/inventory/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def update_inventory(id):
    conn = db.get_db_connection()
    curr = conn.execute('SELECT images, pdfs FROM inventario WHERE id=?', (id,)).fetchone()
    curr_imgs = utils.normalize_files(json.loads(curr['images']) if curr['images'] else [])
    curr_pdfs = utils.normalize_files(json.loads(curr['pdfs']) if curr['pdfs'] else [])
    del_imgs = [int(x) for x in request.form.getlist('delete_images')]
    kept_imgs = [x for i, x in enumerate(curr_imgs) if i not in del_imgs]
    for f in request.files.getlist('images'):
        if f and utils.allowed_file_image(f.filename): kept_imgs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_imgs)>5: kept_imgs=kept_imgs[:5]
    del_pdfs = [int(x) for x in request.form.getlist('delete_pdfs')]
    kept_pdfs = [x for i, x in enumerate(curr_pdfs) if i not in del_pdfs]
    for f in request.files.getlist('pdfs'):
        if f and utils.allowed_file_pdf(f.filename): kept_pdfs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_pdfs)>5: kept_pdfs=kept_pdfs[:5]
    conn.execute('UPDATE inventario SET nombre=?, tipo_id=?, descripcion=?, images=?, pdfs=? WHERE id=?',
                 (request.form['nombre'], request.form['tipo_id'], request.form['descripcion'], json.dumps(kept_imgs), json.dumps(kept_pdfs), id))
    conn.commit()
    conn.close()
    utils.log_action(f"Inventario actualizado: ID {id}")
    flash('Actualizado', 'success')
    return redirect(url_for('inventory'))

@app.route('/inventory/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def delete_inventory(id):
    conn = db.get_db_connection()
    try:
        conn.execute('DELETE FROM ordenes_trabajo WHERE actividad_id IN (SELECT id FROM actividades WHERE equipo_id = ?)', (id,))
        conn.execute('DELETE FROM actividades WHERE equipo_id = ?', (id,))
        conn.execute('DELETE FROM correctivos WHERE equipo_id = ?', (id,))
        conn.execute('DELETE FROM inventario WHERE id = ?', (id,))
        conn.commit()
        utils.log_action(f"Equipo eliminado: ID {id}")
        flash('Equipo eliminado.', 'success')
    except Exception as e:
        conn.rollback()
        flash(f'Error al eliminar: {e}', 'danger')
    finally: conn.close()
    return redirect(url_for('inventory'))

@app.route('/inventory/print/<int:id>')
@utils.login_required
def print_inventory(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id WHERE i.id=?', (id,)).fetchone()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    utils.log_action(f"Impreso inventario: ID {id}")
    return render_template('print/inventory.html', item=item, imgs=imgs, pdfs=pdfs, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/inventory/print_all')
@utils.login_required
def print_all_inventory():
    conn = db.get_db_connection()
    items = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id ORDER BY i.nombre').fetchall()
    conn.close()
    utils.log_action("Impreso listado inventario")
    return render_template('print/all_inventory.html', items=items, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/view_files/<source>/<tipo>/<int:id>')
@utils.login_required
def view_files(source, tipo, id):
    conn = db.get_db_connection()
    if source == 'inventory':
        item = conn.execute('SELECT * FROM inventario WHERE id=?', (id,)).fetchone()
        back_url = url_for('inventory')
        title_prefix = "Archivos de Equipo"
    elif source == 'corrective':
        item = conn.execute('SELECT * FROM correctivos WHERE id=?', (id,)).fetchone()
        back_url = url_for('correctivos')
        title_prefix = "Archivos de Incidencia"
    else:
        item = None
        back_url = url_for('inventory')
        title_prefix = "Archivos"
    conn.close()
    files = []
    if item:
        content = item['images'] if tipo == 'img' else item['pdfs']
        files = utils.normalize_files(json.loads(content) if content else [])
    return render_template('viewer.html', item=item, files=files, tipo=tipo, back_url=back_url, title_prefix=title_prefix, active_page='inventario', system_date=utils.get_system_date())

# ==========================================
# ACTIVIDADES (CON LÓGICA DE GENERACIÓN AUTOMÁTICA)
# ==========================================

@app.route('/activities')
@utils.login_required
@utils.permission_required('perm_actividades')
def activities():
    conn = db.get_db_connection()
    actividades = conn.execute('SELECT a.*, i.nombre as equipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id = i.id').fetchall()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id = t.id').fetchall()
    conn.close()
    return render_template('activities/index.html', actividades=actividades, equipos=equipos, active_page='actividades', system_date=utils.get_system_date())

@app.route('/activities/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def add_activity():
    conn = db.get_db_connection()
    # Leemos si el usuario quiere generar OTs (checkbox en formulario)
    generar_ot = 1 if 'generar_ot' in request.form else 0
    
    conn.execute('INSERT INTO actividades (nombre, equipo_id, periodicidad, operaciones, fecha_inicio_gen, generar_ot) VALUES (?,?,?,?,?,?)',
                 (request.form['nombre'], request.form['equipo_id'], request.form['periodicidad'], request.form['operaciones'], request.form['fecha_inicio'], generar_ot))
    
    # IMPORTANTE: Commit para guardar la actividad ANTES de generar las OTs
    conn.commit() 
    
    # Si la actividad se crea con el check activo, generamos sus primeras OTs inmediatamente
    if generar_ot:
        utils.generate_and_update_work_orders(conn, utils.get_system_date())
        conn.commit()
    
    conn.close()
    utils.log_action(f"Actividad creada: {request.form['nombre']}")
    flash('Actividad creada y plan generado', 'success')
    return redirect(url_for('activities'))

@app.route('/activities/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_actividades')
def edit_activity(id):
    conn = db.get_db_connection()
    activity = conn.execute('SELECT * FROM actividades WHERE id=?', (id,)).fetchone()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id = t.id').fetchall()
    conn.close()
    return render_template('activities/edit.html', activity=activity, equipos=equipos, active_page='actividades', system_date=utils.get_system_date())

@app.route('/activities/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def update_activity(id):
    conn = db.get_db_connection()
    generar_ot = 1 if 'generar_ot' in request.form else 0
    
    conn.execute('UPDATE actividades SET nombre=?, equipo_id=?, periodicidad=?, operaciones=?, fecha_inicio_gen=?, generar_ot=? WHERE id=?',
                 (request.form['nombre'], request.form['equipo_id'], request.form['periodicidad'], request.form['operaciones'], request.form['fecha_inicio'], generar_ot, id))
    
    # LÓGICA DE ACTUALIZACIÓN DE OTS:
    # 1. Borramos las OTs futuras ('Prevista') porque la periodicidad o fecha pudo haber cambiado
    #    o porque el usuario desactivó la generación de OTs.
    conn.execute("DELETE FROM ordenes_trabajo WHERE actividad_id=? AND estado='Prevista'", (id,))
    
    # 2. Guardamos cambios
    conn.commit()
    
    # 3. Regeneramos el plan. La función generate_and_update_work_orders respetará el flag generar_ot.
    #    Si generar_ot es 1, rellenará los huecos borrados con las nuevas fechas.
    #    Si generar_ot es 0, no creará nada nuevo (y las 'Prevista' ya fueron borradas).
    utils.generate_and_update_work_orders(conn, utils.get_system_date())
    conn.commit()
    
    conn.close()
    utils.log_action(f"Actividad actualizada: ID {id}")
    flash('Actividad actualizada y plan recalculado', 'success')
    return redirect(url_for('activities'))

@app.route('/activities/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def delete_activity(id):
    conn = db.get_db_connection()
    try:
        # Aquí se borran TODAS las OTs (incluidas historial) al borrar la actividad madre
        conn.execute('DELETE FROM ordenes_trabajo WHERE actividad_id = ?', (id,))
        conn.execute('DELETE FROM actividades WHERE id = ?', (id,))
        conn.commit()
        utils.log_action(f"Actividad eliminada: ID {id}")
        flash('Actividad eliminada.', 'success')
    except Exception as e:
        conn.rollback()
        flash(f'Error al eliminar: {e}', 'danger')
    finally: conn.close()
    return redirect(url_for('activities'))

@app.route('/activities/print/<int:id>')
@utils.login_required
def print_activity_single(id):
    conn = db.get_db_connection()
    activity = conn.execute('SELECT a.*, i.nombre as equipo_nombre, t.nombre as tipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id=i.id JOIN tipos_equipo t ON i.tipo_id=t.id WHERE a.id=?', (id,)).fetchone()
    conn.close()
    utils.log_action(f"Impresa actividad: ID {id}")
    return render_template('print/activity.html', activity=activity, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/activities/print_all')
@utils.login_required
def print_all_activities():
    conn = db.get_db_connection()
    activities = conn.execute('SELECT a.*, i.nombre as equipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id=i.id ORDER BY a.nombre').fetchall()
    conn.close()
    utils.log_action("Impreso listado actividades")
    return render_template('print/all_activities.html', activities=activities, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# ÓRDENES DE TRABAJO
# ==========================================

@app.route('/work_orders')
@utils.login_required
def work_orders():
    conn = db.get_db_connection()
    q = 'SELECT ot.*, a.operaciones, i.nombre as equipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id = a.id JOIN inventario i ON a.equipo_id = i.id ORDER BY ot.fecha_generacion DESC'
    ots = conn.execute(q).fetchall()
    conn.close()
    return render_template('work_orders/index.html', ots=ots, active_page='ots', system_date=utils.get_system_date())

@app.route('/work_orders/generate', methods=['POST'])
@utils.login_required
def generate_work_orders():
    conn = db.get_db_connection()
    current_date = utils.get_system_date()
    # Esta función en utils ya debe incluir la lógica de ignorar actividades con generar_ot=0
    count = utils.generate_and_update_work_orders(conn, current_date)
    conn.commit()
    conn.close()
    utils.log_action("Generación manual de OTs")
    flash(f'Generadas {count} nuevas órdenes.', 'info')
    return redirect(url_for('work_orders'))

@app.route('/work_orders/update/<int:id>', methods=['POST'])
@utils.login_required
def update_ot(id):
    conn = db.get_db_connection()
    redirect_target = 'calendar_view' if request.form.get('redirect_to') == 'calendar' else 'work_orders'
    if request.form.get('redirect_to') == 'cronograma': redirect_target = 'cronograma'
    
    # NEW: Capturamos la fecha del calendario si existe
    calendar_date = request.form.get('current_calendar_date')
    # NEW: Capturamos el año del cronograma si existe
    cronograma_year = request.form.get('cronograma_year')
    
    conn.execute('UPDATE ordenes_trabajo SET estado=?, observaciones=?, fecha_realizada=? WHERE id=?', (request.form['estado'], request.form['observaciones'], request.form['fecha_realizada'], id))
    conn.commit()
    conn.close()
    utils.log_action(f"OT actualizada: ID {id}")
    flash('OT actualizada', 'success')
    
    # Si volvemos al calendario y tenemos una fecha, la pasamos como parámetro
    if redirect_target == 'calendar_view' and calendar_date:
        return redirect(url_for('calendar_view', date=calendar_date))
    
    # Si volvemos al cronograma y tenemos un año, lo pasamos como parámetro
    if redirect_target == 'cronograma' and cronograma_year:
        return redirect(url_for('cronograma', year=cronograma_year))
        
    return redirect(url_for(redirect_target))

@app.route('/work_orders/print/<int:id>')
@utils.login_required
def print_ot(id):
    conn = db.get_db_connection()
    ot = conn.execute('SELECT ot.*, a.operaciones, i.nombre as equipo_nombre, t.nombre as tipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id=a.id JOIN inventario i ON a.equipo_id=i.id JOIN tipos_equipo t ON i.tipo_id=t.id WHERE ot.id=?', (id,)).fetchone()
    conn.close()
    utils.log_action(f"Impresa OT: ID {id}")
    return render_template('print/ot.html', ot=ot, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/work_orders/print_all')
@utils.login_required
def print_all_ots():
    conn = db.get_db_connection()
    q = 'SELECT ot.*, i.nombre as equipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id=a.id JOIN inventario i ON a.equipo_id=i.id ORDER BY ot.fecha_generacion DESC'
    ots = conn.execute(q).fetchall()
    conn.close()
    utils.log_action("Impreso listado OTs")
    return render_template('print/all_ots.html', ots=ots, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/cronograma')
@utils.login_required
def cronograma():
    year = request.args.get('year', utils.get_system_date().year, type=int)
    meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
    conn = db.get_db_connection()
    data = utils.get_cronograma_data(conn, year)
    conn.close()
    return render_template('work_orders/cronograma.html', data=data, meses=meses, year=year, active_page='cronograma', system_date=utils.get_system_date())

@app.route('/cronograma/print')
@utils.login_required
def print_cronograma():
    year = request.args.get('year', utils.get_system_date().year, type=int)
    meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
    conn = db.get_db_connection()
    data = utils.get_cronograma_data(conn, year)
    conn.close()
    utils.log_action(f"Impreso cronograma año {year}")
    return render_template('print/cronograma.html', data=data, meses=meses, year=year, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# CORRECTIVOS
# ==========================================

@app.route('/correctivos')
@utils.login_required
def correctivos():
    conn = db.get_db_connection()
    items = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id ORDER BY c.fecha_detectada DESC').fetchall()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    return render_template('correctivos/index.html', correctivos=items, equipos=equipos, active_page='correctivos', system_date=utils.get_system_date())

@app.route('/correctivos/add', methods=['POST'])
@utils.login_required
def add_correctivo():
    images_list = []
    for f in request.files.getlist('images')[:5]:
        if f and utils.allowed_file_image(f.filename): images_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    pdfs_list = []
    for f in request.files.getlist('pdfs')[:5]:
        if f and utils.allowed_file_pdf(f.filename): pdfs_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    conn = db.get_db_connection()
    conn.execute('INSERT INTO correctivos (nombre, equipo_id, comentario, fecha_detectada, estado, images, pdfs) VALUES (?,?,?,?,?,?,?)',
                 (request.form['nombre'], request.form['equipo_id'], request.form['comentario'], request.form['fecha_detectada'], request.form['estado'], json.dumps(images_list), json.dumps(pdfs_list)))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia creada: {request.form['nombre']}")
    flash('Incidencia registrada', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/edit/<int:id>')
@utils.login_required
def edit_correctivo(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT * FROM correctivos WHERE id=?', (id,)).fetchone()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    return render_template('correctivos/edit.html', item=item, equipos=equipos, imgs=imgs, pdfs=pdfs, active_page='correctivos', system_date=utils.get_system_date())

@app.route('/correctivos/update/<int:id>', methods=['POST'])
@utils.login_required
def update_correctivo(id):
    conn = db.get_db_connection()
    curr = conn.execute('SELECT images, pdfs FROM correctivos WHERE id=?', (id,)).fetchone()
    curr_imgs = utils.normalize_files(json.loads(curr['images']) if curr['images'] else [])
    curr_pdfs = utils.normalize_files(json.loads(curr['pdfs']) if curr['pdfs'] else [])
    del_imgs = [int(x) for x in request.form.getlist('delete_images')]
    kept_imgs = [x for i, x in enumerate(curr_imgs) if i not in del_imgs]
    for f in request.files.getlist('images'):
        if f and utils.allowed_file_image(f.filename): kept_imgs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_imgs)>5: kept_imgs=kept_imgs[:5]
    del_pdfs = [int(x) for x in request.form.getlist('delete_pdfs')]
    kept_pdfs = [x for i, x in enumerate(curr_pdfs) if i not in del_pdfs]
    for f in request.files.getlist('pdfs'):
        if f and utils.allowed_file_pdf(f.filename): kept_pdfs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_pdfs)>5: kept_pdfs=kept_pdfs[:5]
    conn.execute('UPDATE correctivos SET nombre=?, equipo_id=?, comentario=?, solucion=?, fecha_detectada=?, fecha_resolucion=?, estado=?, images=?, pdfs=? WHERE id=?',
                 (request.form['nombre'], request.form['equipo_id'], request.form['comentario'], request.form['solucion'], request.form['fecha_detectada'], request.form['fecha_resolucion'], request.form['estado'], json.dumps(kept_imgs), json.dumps(kept_pdfs), id))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia actualizada: ID {id}")
    flash('Incidencia actualizada', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/delete/<int:id>', methods=['POST'])
@utils.login_required
def delete_correctivo(id):
    conn = db.get_db_connection()
    conn.execute('DELETE FROM correctivos WHERE id=?', (id,))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia eliminada: ID {id}")
    flash('Eliminado', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/print/<int:id>')
@utils.login_required
def print_correctivo(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id WHERE c.id=?', (id,)).fetchone()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else []) 
    utils.log_action(f"Impresa incidencia: ID {id}")
    return render_template('print/correctivo.html', item=item, imgs=imgs, pdfs=pdfs, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/correctivos/print_all')
@utils.login_required
def print_all_correctivos():
    conn = db.get_db_connection()
    items = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id ORDER BY c.fecha_detectada DESC').fetchall()
    conn.close()
    utils.log_action("Impreso listado incidencias")
    return render_template('print/all_correctivos.html', items=items, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# CONFIGURACIÓN GENERAL
# ==========================================

@app.route('/general_settings')
@utils.login_required
@utils.permission_required('perm_configuracion')
def general_settings():
    logging_enabled = utils.is_logging_enabled()
    log_size_str = "0 KB"
    if os.path.exists(utils.LOG_FILE):
        size_bytes = os.path.getsize(utils.LOG_FILE)
        log_size_str = f"{size_bytes} bytes" if size_bytes < 1024 else f"{size_bytes / 1024:.2f} KB"
    planned_date = utils.get_planned_date()
    # Obtenemos nombre del mantenimiento, aunque ya lo tenemos por context_processor, lo pasamos explícitamente si se desea
    maintenance_name = utils.get_maintenance_name()
    
    conn = db.get_db_connection()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    users = conn.execute('SELECT * FROM usuarios').fetchall()
    conn.close()
    return render_template('settings/index.html', logging_enabled=logging_enabled, log_size=log_size_str, tipos=tipos, users=users, planned_date=planned_date, maintenance_name=maintenance_name, active_page='ajustes', system_date=utils.get_system_date())

# RUTA NUEVA: ACTUALIZAR NOMBRE DEL MANTENIMIENTO
@app.route('/settings/update_maintenance_name', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_maintenance_name():
    name = request.form['nombre_mantenimiento']
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET nombre_mantenimiento=? WHERE id=1', (name,))
    conn.commit()
    conn.close()
    utils.log_action(f"Nombre del mantenimiento actualizado a: {name}")
    flash('Nombre del mantenimiento actualizado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/settings/update_planned_date', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_planned_date():
    planned_str = request.form['fecha_prevista']
    planned_date = datetime.datetime.strptime(planned_str, '%Y-%m-%d').date()
    system_date = utils.get_system_date()
    if planned_date <= system_date:
        flash("La fecha prevista debe ser posterior a la fecha del sistema.", "danger")
        return redirect(url_for('general_settings'))
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET fecha_prevista = ? WHERE id = 1', (planned_str,))
    conn.execute("DELETE FROM ordenes_trabajo WHERE estado = 'Prevista'")
    actividades = conn.execute('SELECT * FROM actividades').fetchall()
    count_generated = 0
    for act in actividades:
        # LÓGICA DE CONTROL: Si la actividad tiene generar_ot desactivado, saltamos
        if not act['generar_ot']:
            continue

        f_inicio = datetime.datetime.strptime(act['fecha_inicio_gen'], '%Y-%m-%d').date()
        periodicity = act['periodicidad']
        if f_inicio > system_date: current_calc = f_inicio
        else:
            delta_days = (system_date - f_inicio).days
            periods_passed = delta_days // periodicity
            current_calc = f_inicio + datetime.timedelta(days=(periods_passed + 1) * periodicity)
        while current_calc <= planned_date:
             if not conn.execute('SELECT id FROM ordenes_trabajo WHERE actividad_id=? AND fecha_generacion=?', (act['id'], current_calc)).fetchone():
                 nombre_ot = f"{act['nombre']} - {current_calc.strftime('%d/%m/%Y')}"
                 # Modified Logic: Based on Month/Year strict comparison
                 if current_calc.year < system_date.year or (current_calc.year == system_date.year and current_calc.month < system_date.month):
                     st = 'Pendiente'
                 elif current_calc.year == system_date.year and current_calc.month == system_date.month:
                     st = 'En curso'
                 else:
                     st = 'Prevista'
                     
                 conn.execute('INSERT INTO ordenes_trabajo (actividad_id, nombre, fecha_generacion, estado) VALUES (?,?,?,?)', 
                              (act['id'], nombre_ot, current_calc, st))
                 count_generated += 1
             current_calc += datetime.timedelta(days=periodicity)
    conn.commit()
    conn.close()
    utils.log_action(f"Plan regenerado: {count_generated} OTs.")
    flash(f"Plan actualizado. Generadas {count_generated} OTs.", "success")
    return redirect(url_for('general_settings'))

@app.route('/system_date_config/update', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_system_date():
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET fecha_sistema=? WHERE id=1', (request.form['fecha_sistema'],))
    conn.commit()
    conn.close()
    return redirect(url_for('general_settings'))

@app.route('/settings/toggle_logging', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def toggle_logging():
    enabled = 1 if 'logging_enabled' in request.form else 0
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET logging_enabled = ? WHERE id = 1', (enabled,))
    conn.commit()
    conn.close()
    flash(f"Logging {'activado' if enabled else 'desactivado'}", "success")
    return redirect(url_for('general_settings'))

@app.route('/settings/download_log')
@utils.login_required
@utils.permission_required('perm_configuracion')
def download_log():
    if os.path.exists(utils.LOG_FILE): return send_file(utils.LOG_FILE, as_attachment=True)
    flash("Log vacío.", "warning"); return redirect(url_for('general_settings'))

@app.route('/settings/backup_db')
@utils.login_required
@utils.permission_required('perm_configuracion')
def backup_db():
    db_file = db.DB_NAME # 'mantenimiento_factory.db'
    if not os.path.exists(db_file):
        flash("No se encuentra la base de datos.", "danger")
        return redirect(url_for('general_settings'))
    
    timestamp = datetime.datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
    backup_name = f"backup_mantenimiento_{timestamp}.bak"
    
    utils.log_action("Descargada copia de seguridad de la BD")
    return send_file(db_file, as_attachment=True, download_name=backup_name)

# RUTA NUEVA: RESTAURAR COPIA DE SEGURIDAD
@app.route('/settings/restore_db', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def restore_db():
    if 'db_file' not in request.files:
        flash('No se seleccionó ningún archivo', 'danger')
        return redirect(url_for('general_settings'))
    
    file = request.files['db_file']
    if file.filename == '':
        flash('No se seleccionó ningún archivo', 'danger')
        return redirect(url_for('general_settings'))

    if file and utils.allowed_file_db(file.filename):
        try:
            # 1. Guardar archivo temporal
            temp_path = "restore_temp.db"
            file.save(temp_path)
            
            # 2. Verificar que es una BD SQLite válida
            try:
                verify_conn = sqlite3.connect(temp_path)
                verify_conn.execute("SELECT name FROM sqlite_master WHERE type='table'")
                verify_conn.close()
            except sqlite3.Error:
                os.remove(temp_path)
                flash('El archivo subido no es una base de datos SQLite válida o está corrupto.', 'danger')
                return redirect(url_for('general_settings'))

            # 3. Sustituir la base de datos actual
            # Hacemos un backup rápido de la actual por si falla el move (solo un renombrado)
            current_db = db.DB_NAME
            backup_fail_safe = current_db + ".restore_backup"
            
            if os.path.exists(current_db):
                shutil.move(current_db, backup_fail_safe)
            
            try:
                shutil.move(temp_path, current_db)
                # Si todo ha ido bien, borramos el backup de seguridad
                if os.path.exists(backup_fail_safe):
                    os.remove(backup_fail_safe)
                    
                utils.log_action("Base de datos restaurada desde copia de seguridad")
                flash('Base de datos restaurada con éxito. Por seguridad, inicie sesión nuevamente.', 'success')
                return redirect(url_for('logout'))
                
            except Exception as e:
                # Si falla mover el nuevo archivo, restauramos el original
                if os.path.exists(backup_fail_safe):
                    shutil.move(backup_fail_safe, current_db)
                raise e

        except Exception as e:
            flash(f'Error al restaurar la base de datos: {str(e)}', 'danger')
            return redirect(url_for('general_settings'))
    else:
        flash('Formato de archivo no válido. Use .db, .sqlite o .bak', 'danger')
        return redirect(url_for('general_settings'))

@app.route('/users/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def add_user():
    try:
        pw_hash = generate_password_hash(request.form['password'])
        p_inv = 1 if 'perm_inventario' in request.form else 0
        p_act = 1 if 'perm_actividades' in request.form else 0
        p_conf = 1 if 'perm_configuracion' in request.form else 0
        conn = db.get_db_connection()
        conn.execute('INSERT INTO usuarios (username, password_hash, rol, perm_inventario, perm_actividades, perm_configuracion) VALUES (?,?,?,?,?,?)',
                     (request.form['username'], pw_hash, request.form['rol'], p_inv, p_act, p_conf))
        conn.commit()
        conn.close()
        utils.log_action(f"Usuario creado: {request.form['username']}")
        flash('Usuario creado', 'success')
    except: flash('Error al crear usuario', 'danger')
    return redirect(url_for('general_settings'))

@app.route('/users/edit/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def edit_user(id):
    p_inv = 1 if 'perm_inventario' in request.form else 0
    p_act = 1 if 'perm_actividades' in request.form else 0
    p_conf = 1 if 'perm_configuracion' in request.form else 0
    conn = db.get_db_connection()
    if request.form['password']:
        pw = generate_password_hash(request.form['password'])
        conn.execute('UPDATE usuarios SET rol=?, perm_inventario=?, perm_actividades=?, perm_configuracion=?, password_hash=? WHERE id=?', (request.form['rol'], p_inv, p_act, p_conf, pw, id))
    else:
        conn.execute('UPDATE usuarios SET rol=?, perm_inventario=?, perm_actividades=?, perm_configuracion=? WHERE id=?', (request.form['rol'], p_inv, p_act, p_conf, id))
    conn.commit()
    conn.close()
    utils.log_action(f"Usuario editado: ID {id}")
    flash('Usuario actualizado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/users/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def delete_user(id):
    conn = db.get_db_connection()
    conn.execute('DELETE FROM usuarios WHERE id=?', (id,))
    conn.commit()
    conn.close()
    utils.log_action(f"Usuario eliminado: ID {id}")
    flash('Usuario eliminado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/configuration/type/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def add_type_config():
    try:
        conn = db.get_db_connection()
        conn.execute('INSERT INTO tipos_equipo (nombre) VALUES (?)', (request.form['nombre'],))
        conn.commit()
        conn.close()
        utils.log_action(f"Tipo creado: {request.form['nombre']}")
    except: pass
    return redirect(url_for('general_settings'))

@app.route('/configuration/type/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_configuracion')
def edit_type(id):
    conn = db.get_db_connection()
    tipo = conn.execute('SELECT * FROM tipos_equipo WHERE id=?', (id,)).fetchone()
    conn.close()
    return render_template('settings/edit_type.html', tipo=tipo, active_page='ajustes', system_date=utils.get_system_date())

@app.route('/configuration/type/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_type(id):
    try:
        conn = db.get_db_connection()
        conn.execute('UPDATE tipos_equipo SET nombre=? WHERE id=?', (request.form['nombre'], id))
        conn.commit()
        conn.close()
    except: pass
    return redirect(url_for('general_settings'))

# NUEVA RUTA DE AYUDA
@app.route('/help')
@utils.login_required
def help_page():
    return render_template('help.html', active_page='help', system_date=utils.get_system_date())

@app.route('/about')
def about():
    return render_template('about.html', active_page='about', system_date=utils.get_system_date())

@app.route('/types/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def add_type():
    try:
        conn = db.get_db_connection()
        conn.execute('INSERT INTO tipos_equipo (nombre) VALUES (?)', (request.form['nombre'],))
        conn.commit()
        conn.close()
    except: pass
    return redirect(url_for('inventory'))

# ==========================================
# RUTAS NUEVAS PARA EL CALENDARIO (COLORES ACTUALIZADOS)
# ==========================================

@app.route('/calendar')
@utils.login_required
def calendar_view():
    return render_template('calendar/index.html', active_page='calendario', system_date=utils.get_system_date())

@app.route('/api/calendar_events')
@utils.login_required
def get_calendar_events():
    conn = db.get_db_connection()
    ots = conn.execute('SELECT id, nombre, fecha_generacion, estado, observaciones FROM ordenes_trabajo').fetchall()
    conn.close()
    
    events = []
    for ot in ots:
        color = '#6c757d' # Default
        estado = ot['estado']
        
        if estado == 'Pendiente': color = '#dc3545'      # Rojo
        elif estado == 'En curso': color = '#ffc107'     # Amarillo
        elif estado == 'Realizada': color = '#28a745'    # Verde
        elif estado == 'Prevista': color = '#6c757d'     # Gris
        elif estado == 'Aplazada': color = '#6f42c1'     # Violeta
        elif estado == 'Rechazada': color = '#000000'    # Negra
        
        events.append({
            'id': ot['id'],
            'title': ot['nombre'],
            'start': ot['fecha_generacion'],
            'color': color,
            'url': url_for('work_orders'),
            'extendedProps': {
                'estado': estado,
                'observaciones': ot['observaciones'] or ''
            }
        })
        
    return json.dumps(events)

if __name__ == '__main__':
    if not os.path.exists('mantenimiento_factory.db'):
        db.init_db()
    db.init_db()
    utils.create_default_admin()
    print("Sincronizando fecha del sistema...")
    try:
        conn = db.get_db_connection()
        real_today = datetime.date.today()
        # Usamos .isoformat() para convertir el objeto fecha a texto "YYYY-MM-DD"
        conn.execute('UPDATE configuracion SET fecha_sistema=? WHERE id=1', (real_today.isoformat(),))
        count = utils.generate_and_update_work_orders(conn, real_today)
        conn.commit()
        conn.close()
        print(f"Sistema sincronizado a {real_today}. OTs procesadas: {count}")
    except Exception as e: print(f"Error en sincronización inicial: {e}")
    print("Iniciando Sistema GMAO...")
    print("Accesible en tu red local. Busca tu IP (ej: ipconfig o ifconfig)")
    ## app.run(debug=True, port=5000, host='0.0.0.0')
    serve(app, port=5000, host='0.0.0.0')
--- FIN ARCHIVO: app.py ---

--- INICIO ARCHIVO: contexto_proyecto.txt ---
ESTRUCTURA DEL PROYECTO:
./
    app.py
    contexto_proyecto.txt
    database.py
    Empaquetador_de_Proyectos.py
    requirements.txt
    resumen.py
    utils.py
    templates/
        about.html
        base.html
        help.html
        login.html
        viewer.html
        activities/
            edit.html
            index.html
        calendar/
            index.html
        correctivos/
            edit.html
            index.html
        inventory/
            edit.html
            index.html
        print/
            activity.html
            all_activities.html
            all_correctivos.html
            all_inventory.html
            all_ots.html
            correctivo.html
            cronograma.html
            inventory.html
            ot.html
        resumen/
            index.html
        settings/
            edit_type.html
            index.html
        work_orders/
            cronograma.html
            index.html

==================================================
CONTENIDO DE LOS ARCHIVOS:
==================================================

--- INICIO ARCHIVO: app.py ---
import sqlite3
import base64
import datetime
from flask import Flask, render_template, request, redirect, url_for, flash, send_file, session
import json
import os
import shutil
from werkzeug.security import check_password_hash, generate_password_hash
import database as db
import utils
from resumen import resumen_bp
from waitress import serve

app = Flask(__name__)
app.secret_key = 'super_secret_key_mantenimiento_factory'
app.register_blueprint(resumen_bp, url_prefix='/resumen')

@app.template_filter('json_load')
def json_load_filter(s):
    return utils.json_load_filter(s)

# Context Processor para inyectar el nombre del mantenimiento en todas las vistas
@app.context_processor
def inject_maintenance_name():
    return dict(maintenance_name=utils.get_maintenance_name())

# ==========================================
# AUTENTICACIÓN
# ==========================================

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        conn = db.get_db_connection()
        user = conn.execute('SELECT * FROM usuarios WHERE username = ?', (username,)).fetchone()
        conn.close()
        if user and check_password_hash(user['password_hash'], password):
            session['user_id'] = user['id']
            session['username'] = user['username']
            session['rol'] = user['rol']
            session['perm_inventario'] = user['perm_inventario']
            session['perm_actividades'] = user['perm_actividades']
            session['perm_configuracion'] = user['perm_configuracion']
            utils.log_action(f"Inicio de sesión exitoso: {username}")
            return redirect(url_for('index'))
        else:
            flash('Usuario o contraseña incorrectos', 'danger')
    return render_template('login.html')

@app.route('/logout')
def logout():
    utils.log_action(f"Cierre de sesión: {session.get('username')}")
    session.clear()
    return redirect(url_for('login'))

@app.route('/')
@utils.login_required
def index():
    return redirect(url_for('resumen.index'))

# ==========================================
# INVENTARIO
# ==========================================

@app.route('/inventory')
@utils.login_required
def inventory():
    db.init_db()
    conn = db.get_db_connection()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    items = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    return render_template('inventory/index.html', items=items, tipos=tipos, active_page='inventario', system_date=utils.get_system_date())

@app.route('/inventory/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def add_inventory():
    try:
        images_list = []
        for f in request.files.getlist('images')[:5]:
             if f and utils.allowed_file_image(f.filename): images_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
        pdfs_list = []
        for f in request.files.getlist('pdfs')[:5]:
             if f and utils.allowed_file_pdf(f.filename): pdfs_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
        conn = db.get_db_connection()
        conn.execute('INSERT INTO inventario (nombre, tipo_id, descripcion, images, pdfs) VALUES (?, ?, ?, ?, ?)',
                     (request.form['nombre'], request.form['tipo_id'], request.form['descripcion'], json.dumps(images_list), json.dumps(pdfs_list)))
        conn.commit()
        conn.close()
        utils.log_action(f"Inventario añadido: {request.form['nombre']}")
        flash('Equipo añadido', 'success')
    except Exception as e: flash(f'Error: {e}', 'danger')
    return redirect(url_for('inventory'))

@app.route('/inventory/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_inventario')
def edit_inventory(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT * FROM inventario WHERE id=?', (id,)).fetchone()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    conn.close()
    if not item: return redirect(url_for('inventory'))
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    return render_template('inventory/edit.html', item=item, tipos=tipos, imgs=imgs, pdfs=pdfs, active_page='inventario', system_date=utils.get_system_date())

@app.route('/inventory/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def update_inventory(id):
    conn = db.get_db_connection()
    curr = conn.execute('SELECT images, pdfs FROM inventario WHERE id=?', (id,)).fetchone()
    curr_imgs = utils.normalize_files(json.loads(curr['images']) if curr['images'] else [])
    curr_pdfs = utils.normalize_files(json.loads(curr['pdfs']) if curr['pdfs'] else [])
    del_imgs = [int(x) for x in request.form.getlist('delete_images')]
    kept_imgs = [x for i, x in enumerate(curr_imgs) if i not in del_imgs]
    for f in request.files.getlist('images'):
        if f and utils.allowed_file_image(f.filename): kept_imgs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_imgs)>5: kept_imgs=kept_imgs[:5]
    del_pdfs = [int(x) for x in request.form.getlist('delete_pdfs')]
    kept_pdfs = [x for i, x in enumerate(curr_pdfs) if i not in del_pdfs]
    for f in request.files.getlist('pdfs'):
        if f and utils.allowed_file_pdf(f.filename): kept_pdfs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_pdfs)>5: kept_pdfs=kept_pdfs[:5]
    conn.execute('UPDATE inventario SET nombre=?, tipo_id=?, descripcion=?, images=?, pdfs=? WHERE id=?',
                 (request.form['nombre'], request.form['tipo_id'], request.form['descripcion'], json.dumps(kept_imgs), json.dumps(kept_pdfs), id))
    conn.commit()
    conn.close()
    utils.log_action(f"Inventario actualizado: ID {id}")
    flash('Actualizado', 'success')
    return redirect(url_for('inventory'))

@app.route('/inventory/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def delete_inventory(id):
    conn = db.get_db_connection()
    try:
        conn.execute('DELETE FROM ordenes_trabajo WHERE actividad_id IN (SELECT id FROM actividades WHERE equipo_id = ?)', (id,))
        conn.execute('DELETE FROM actividades WHERE equipo_id = ?', (id,))
        conn.execute('DELETE FROM correctivos WHERE equipo_id = ?', (id,))
        conn.execute('DELETE FROM inventario WHERE id = ?', (id,))
        conn.commit()
        utils.log_action(f"Equipo eliminado: ID {id}")
        flash('Equipo eliminado.', 'success')
    except Exception as e:
        conn.rollback()
        flash(f'Error al eliminar: {e}', 'danger')
    finally: conn.close()
    return redirect(url_for('inventory'))

@app.route('/inventory/print/<int:id>')
@utils.login_required
def print_inventory(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id WHERE i.id=?', (id,)).fetchone()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    utils.log_action(f"Impreso inventario: ID {id}")
    return render_template('print/inventory.html', item=item, imgs=imgs, pdfs=pdfs, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/inventory/print_all')
@utils.login_required
def print_all_inventory():
    conn = db.get_db_connection()
    items = conn.execute('SELECT i.*, t.nombre as tipo_nombre FROM inventario i LEFT JOIN tipos_equipo t ON i.tipo_id=t.id ORDER BY i.nombre').fetchall()
    conn.close()
    utils.log_action("Impreso listado inventario")
    return render_template('print/all_inventory.html', items=items, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/view_files/<source>/<tipo>/<int:id>')
@utils.login_required
def view_files(source, tipo, id):
    conn = db.get_db_connection()
    if source == 'inventory':
        item = conn.execute('SELECT * FROM inventario WHERE id=?', (id,)).fetchone()
        back_url = url_for('inventory')
        title_prefix = "Archivos de Equipo"
    elif source == 'corrective':
        item = conn.execute('SELECT * FROM correctivos WHERE id=?', (id,)).fetchone()
        back_url = url_for('correctivos')
        title_prefix = "Archivos de Incidencia"
    else:
        item = None
        back_url = url_for('inventory')
        title_prefix = "Archivos"
    conn.close()
    files = []
    if item:
        content = item['images'] if tipo == 'img' else item['pdfs']
        files = utils.normalize_files(json.loads(content) if content else [])
    return render_template('viewer.html', item=item, files=files, tipo=tipo, back_url=back_url, title_prefix=title_prefix, active_page='inventario', system_date=utils.get_system_date())

# ==========================================
# ACTIVIDADES (CON LÓGICA DE GENERACIÓN AUTOMÁTICA)
# ==========================================

@app.route('/activities')
@utils.login_required
@utils.permission_required('perm_actividades')
def activities():
    conn = db.get_db_connection()
    actividades = conn.execute('SELECT a.*, i.nombre as equipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id = i.id').fetchall()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id = t.id').fetchall()
    conn.close()
    return render_template('activities/index.html', actividades=actividades, equipos=equipos, active_page='actividades', system_date=utils.get_system_date())

@app.route('/activities/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def add_activity():
    conn = db.get_db_connection()
    # Leemos si el usuario quiere generar OTs (checkbox en formulario)
    generar_ot = 1 if 'generar_ot' in request.form else 0
    
    conn.execute('INSERT INTO actividades (nombre, equipo_id, periodicidad, operaciones, fecha_inicio_gen, generar_ot) VALUES (?,?,?,?,?,?)',
                 (request.form['nombre'], request.form['equipo_id'], request.form['periodicidad'], request.form['operaciones'], request.form['fecha_inicio'], generar_ot))
    
    # IMPORTANTE: Commit para guardar la actividad ANTES de generar las OTs
    conn.commit() 
    
    # Si la actividad se crea con el check activo, generamos sus primeras OTs inmediatamente
    if generar_ot:
        utils.generate_and_update_work_orders(conn, utils.get_system_date())
        conn.commit()
    
    conn.close()
    utils.log_action(f"Actividad creada: {request.form['nombre']}")
    flash('Actividad creada y plan generado', 'success')
    return redirect(url_for('activities'))

@app.route('/activities/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_actividades')
def edit_activity(id):
    conn = db.get_db_connection()
    activity = conn.execute('SELECT * FROM actividades WHERE id=?', (id,)).fetchone()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id = t.id').fetchall()
    conn.close()
    return render_template('activities/edit.html', activity=activity, equipos=equipos, active_page='actividades', system_date=utils.get_system_date())

@app.route('/activities/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def update_activity(id):
    conn = db.get_db_connection()
    generar_ot = 1 if 'generar_ot' in request.form else 0
    
    conn.execute('UPDATE actividades SET nombre=?, equipo_id=?, periodicidad=?, operaciones=?, fecha_inicio_gen=?, generar_ot=? WHERE id=?',
                 (request.form['nombre'], request.form['equipo_id'], request.form['periodicidad'], request.form['operaciones'], request.form['fecha_inicio'], generar_ot, id))
    
    # LÓGICA DE ACTUALIZACIÓN DE OTS:
    # 1. Borramos las OTs futuras ('Prevista') porque la periodicidad o fecha pudo haber cambiado
    #    o porque el usuario desactivó la generación de OTs.
    conn.execute("DELETE FROM ordenes_trabajo WHERE actividad_id=? AND estado='Prevista'", (id,))
    
    # 2. Guardamos cambios
    conn.commit()
    
    # 3. Regeneramos el plan. La función generate_and_update_work_orders respetará el flag generar_ot.
    #    Si generar_ot es 1, rellenará los huecos borrados con las nuevas fechas.
    #    Si generar_ot es 0, no creará nada nuevo (y las 'Prevista' ya fueron borradas).
    utils.generate_and_update_work_orders(conn, utils.get_system_date())
    conn.commit()
    
    conn.close()
    utils.log_action(f"Actividad actualizada: ID {id}")
    flash('Actividad actualizada y plan recalculado', 'success')
    return redirect(url_for('activities'))

@app.route('/activities/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_actividades')
def delete_activity(id):
    conn = db.get_db_connection()
    try:
        # Aquí se borran TODAS las OTs (incluidas historial) al borrar la actividad madre
        conn.execute('DELETE FROM ordenes_trabajo WHERE actividad_id = ?', (id,))
        conn.execute('DELETE FROM actividades WHERE id = ?', (id,))
        conn.commit()
        utils.log_action(f"Actividad eliminada: ID {id}")
        flash('Actividad eliminada.', 'success')
    except Exception as e:
        conn.rollback()
        flash(f'Error al eliminar: {e}', 'danger')
    finally: conn.close()
    return redirect(url_for('activities'))

@app.route('/activities/print/<int:id>')
@utils.login_required
def print_activity_single(id):
    conn = db.get_db_connection()
    activity = conn.execute('SELECT a.*, i.nombre as equipo_nombre, t.nombre as tipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id=i.id JOIN tipos_equipo t ON i.tipo_id=t.id WHERE a.id=?', (id,)).fetchone()
    conn.close()
    utils.log_action(f"Impresa actividad: ID {id}")
    return render_template('print/activity.html', activity=activity, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/activities/print_all')
@utils.login_required
def print_all_activities():
    conn = db.get_db_connection()
    activities = conn.execute('SELECT a.*, i.nombre as equipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id=i.id ORDER BY a.nombre').fetchall()
    conn.close()
    utils.log_action("Impreso listado actividades")
    return render_template('print/all_activities.html', activities=activities, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# ÓRDENES DE TRABAJO
# ==========================================

@app.route('/work_orders')
@utils.login_required
def work_orders():
    conn = db.get_db_connection()
    q = 'SELECT ot.*, a.operaciones, i.nombre as equipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id = a.id JOIN inventario i ON a.equipo_id = i.id ORDER BY ot.fecha_generacion DESC'
    ots = conn.execute(q).fetchall()
    conn.close()
    return render_template('work_orders/index.html', ots=ots, active_page='ots', system_date=utils.get_system_date())

@app.route('/work_orders/generate', methods=['POST'])
@utils.login_required
def generate_work_orders():
    conn = db.get_db_connection()
    current_date = utils.get_system_date()
    # Esta función en utils ya debe incluir la lógica de ignorar actividades con generar_ot=0
    count = utils.generate_and_update_work_orders(conn, current_date)
    conn.commit()
    conn.close()
    utils.log_action("Generación manual de OTs")
    flash(f'Generadas {count} nuevas órdenes.', 'info')
    return redirect(url_for('work_orders'))

@app.route('/work_orders/update/<int:id>', methods=['POST'])
@utils.login_required
def update_ot(id):
    conn = db.get_db_connection()
    redirect_target = 'calendar_view' if request.form.get('redirect_to') == 'calendar' else 'work_orders'
    if request.form.get('redirect_to') == 'cronograma': redirect_target = 'cronograma'
    
    # NEW: Capturamos la fecha del calendario si existe
    calendar_date = request.form.get('current_calendar_date')
    # NEW: Capturamos el año del cronograma si existe
    cronograma_year = request.form.get('cronograma_year')
    
    conn.execute('UPDATE ordenes_trabajo SET estado=?, observaciones=?, fecha_realizada=? WHERE id=?', (request.form['estado'], request.form['observaciones'], request.form['fecha_realizada'], id))
    conn.commit()
    conn.close()
    utils.log_action(f"OT actualizada: ID {id}")
    flash('OT actualizada', 'success')
    
    # Si volvemos al calendario y tenemos una fecha, la pasamos como parámetro
    if redirect_target == 'calendar_view' and calendar_date:
        return redirect(url_for('calendar_view', date=calendar_date))
    
    # Si volvemos al cronograma y tenemos un año, lo pasamos como parámetro
    if redirect_target == 'cronograma' and cronograma_year:
        return redirect(url_for('cronograma', year=cronograma_year))
        
    return redirect(url_for(redirect_target))

@app.route('/work_orders/print/<int:id>')
@utils.login_required
def print_ot(id):
    conn = db.get_db_connection()
    ot = conn.execute('SELECT ot.*, a.operaciones, i.nombre as equipo_nombre, t.nombre as tipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id=a.id JOIN inventario i ON a.equipo_id=i.id JOIN tipos_equipo t ON i.tipo_id=t.id WHERE ot.id=?', (id,)).fetchone()
    conn.close()
    utils.log_action(f"Impresa OT: ID {id}")
    return render_template('print/ot.html', ot=ot, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/work_orders/print_all')
@utils.login_required
def print_all_ots():
    conn = db.get_db_connection()
    q = 'SELECT ot.*, i.nombre as equipo_nombre FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id=a.id JOIN inventario i ON a.equipo_id=i.id ORDER BY ot.fecha_generacion DESC'
    ots = conn.execute(q).fetchall()
    conn.close()
    utils.log_action("Impreso listado OTs")
    return render_template('print/all_ots.html', ots=ots, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/cronograma')
@utils.login_required
def cronograma():
    year = request.args.get('year', utils.get_system_date().year, type=int)
    meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
    conn = db.get_db_connection()
    data = utils.get_cronograma_data(conn, year)
    conn.close()
    return render_template('work_orders/cronograma.html', data=data, meses=meses, year=year, active_page='cronograma', system_date=utils.get_system_date())

@app.route('/cronograma/print')
@utils.login_required
def print_cronograma():
    year = request.args.get('year', utils.get_system_date().year, type=int)
    meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
    conn = db.get_db_connection()
    data = utils.get_cronograma_data(conn, year)
    conn.close()
    utils.log_action(f"Impreso cronograma año {year}")
    return render_template('print/cronograma.html', data=data, meses=meses, year=year, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# CORRECTIVOS
# ==========================================

@app.route('/correctivos')
@utils.login_required
def correctivos():
    conn = db.get_db_connection()
    items = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id ORDER BY c.fecha_detectada DESC').fetchall()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    return render_template('correctivos/index.html', correctivos=items, equipos=equipos, active_page='correctivos', system_date=utils.get_system_date())

@app.route('/correctivos/add', methods=['POST'])
@utils.login_required
def add_correctivo():
    images_list = []
    for f in request.files.getlist('images')[:5]:
        if f and utils.allowed_file_image(f.filename): images_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    pdfs_list = []
    for f in request.files.getlist('pdfs')[:5]:
        if f and utils.allowed_file_pdf(f.filename): pdfs_list.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    conn = db.get_db_connection()
    conn.execute('INSERT INTO correctivos (nombre, equipo_id, comentario, fecha_detectada, estado, images, pdfs) VALUES (?,?,?,?,?,?,?)',
                 (request.form['nombre'], request.form['equipo_id'], request.form['comentario'], request.form['fecha_detectada'], request.form['estado'], json.dumps(images_list), json.dumps(pdfs_list)))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia creada: {request.form['nombre']}")
    flash('Incidencia registrada', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/edit/<int:id>')
@utils.login_required
def edit_correctivo(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT * FROM correctivos WHERE id=?', (id,)).fetchone()
    equipos = conn.execute('SELECT i.id, i.nombre, t.nombre as tipo_nombre FROM inventario i JOIN tipos_equipo t ON i.tipo_id=t.id').fetchall()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else [])
    return render_template('correctivos/edit.html', item=item, equipos=equipos, imgs=imgs, pdfs=pdfs, active_page='correctivos', system_date=utils.get_system_date())

@app.route('/correctivos/update/<int:id>', methods=['POST'])
@utils.login_required
def update_correctivo(id):
    conn = db.get_db_connection()
    curr = conn.execute('SELECT images, pdfs FROM correctivos WHERE id=?', (id,)).fetchone()
    curr_imgs = utils.normalize_files(json.loads(curr['images']) if curr['images'] else [])
    curr_pdfs = utils.normalize_files(json.loads(curr['pdfs']) if curr['pdfs'] else [])
    del_imgs = [int(x) for x in request.form.getlist('delete_images')]
    kept_imgs = [x for i, x in enumerate(curr_imgs) if i not in del_imgs]
    for f in request.files.getlist('images'):
        if f and utils.allowed_file_image(f.filename): kept_imgs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_imgs)>5: kept_imgs=kept_imgs[:5]
    del_pdfs = [int(x) for x in request.form.getlist('delete_pdfs')]
    kept_pdfs = [x for i, x in enumerate(curr_pdfs) if i not in del_pdfs]
    for f in request.files.getlist('pdfs'):
        if f and utils.allowed_file_pdf(f.filename): kept_pdfs.append({'name': f.filename, 'data': utils.file_to_base64(f)})
    if len(kept_pdfs)>5: kept_pdfs=kept_pdfs[:5]
    conn.execute('UPDATE correctivos SET nombre=?, equipo_id=?, comentario=?, solucion=?, fecha_detectada=?, fecha_resolucion=?, estado=?, images=?, pdfs=? WHERE id=?',
                 (request.form['nombre'], request.form['equipo_id'], request.form['comentario'], request.form['solucion'], request.form['fecha_detectada'], request.form['fecha_resolucion'], request.form['estado'], json.dumps(kept_imgs), json.dumps(kept_pdfs), id))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia actualizada: ID {id}")
    flash('Incidencia actualizada', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/delete/<int:id>', methods=['POST'])
@utils.login_required
def delete_correctivo(id):
    conn = db.get_db_connection()
    conn.execute('DELETE FROM correctivos WHERE id=?', (id,))
    conn.commit()
    conn.close()
    utils.log_action(f"Incidencia eliminada: ID {id}")
    flash('Eliminado', 'success')
    return redirect(url_for('correctivos'))

@app.route('/correctivos/print/<int:id>')
@utils.login_required
def print_correctivo(id):
    conn = db.get_db_connection()
    item = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id WHERE c.id=?', (id,)).fetchone()
    conn.close()
    imgs = utils.normalize_files(json.loads(item['images']) if item['images'] else [])
    pdfs = utils.normalize_files(json.loads(item['pdfs']) if item['pdfs'] else []) 
    utils.log_action(f"Impresa incidencia: ID {id}")
    return render_template('print/correctivo.html', item=item, imgs=imgs, pdfs=pdfs, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

@app.route('/correctivos/print_all')
@utils.login_required
def print_all_correctivos():
    conn = db.get_db_connection()
    items = conn.execute('SELECT c.*, i.nombre as equipo_nombre FROM correctivos c JOIN inventario i ON c.equipo_id=i.id ORDER BY c.fecha_detectada DESC').fetchall()
    conn.close()
    utils.log_action("Impreso listado incidencias")
    return render_template('print/all_correctivos.html', items=items, hoy=utils.get_system_date().strftime('%d/%m/%Y'))

# ==========================================
# CONFIGURACIÓN GENERAL
# ==========================================

@app.route('/general_settings')
@utils.login_required
@utils.permission_required('perm_configuracion')
def general_settings():
    logging_enabled = utils.is_logging_enabled()
    log_size_str = "0 KB"
    if os.path.exists(utils.LOG_FILE):
        size_bytes = os.path.getsize(utils.LOG_FILE)
        log_size_str = f"{size_bytes} bytes" if size_bytes < 1024 else f"{size_bytes / 1024:.2f} KB"
    planned_date = utils.get_planned_date()
    # Obtenemos nombre del mantenimiento, aunque ya lo tenemos por context_processor, lo pasamos explícitamente si se desea
    maintenance_name = utils.get_maintenance_name()
    
    conn = db.get_db_connection()
    tipos = conn.execute('SELECT * FROM tipos_equipo').fetchall()
    users = conn.execute('SELECT * FROM usuarios').fetchall()
    conn.close()
    return render_template('settings/index.html', logging_enabled=logging_enabled, log_size=log_size_str, tipos=tipos, users=users, planned_date=planned_date, maintenance_name=maintenance_name, active_page='ajustes', system_date=utils.get_system_date())

# RUTA NUEVA: ACTUALIZAR NOMBRE DEL MANTENIMIENTO
@app.route('/settings/update_maintenance_name', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_maintenance_name():
    name = request.form['nombre_mantenimiento']
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET nombre_mantenimiento=? WHERE id=1', (name,))
    conn.commit()
    conn.close()
    utils.log_action(f"Nombre del mantenimiento actualizado a: {name}")
    flash('Nombre del mantenimiento actualizado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/settings/update_planned_date', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_planned_date():
    planned_str = request.form['fecha_prevista']
    planned_date = datetime.datetime.strptime(planned_str, '%Y-%m-%d').date()
    system_date = utils.get_system_date()
    if planned_date <= system_date:
        flash("La fecha prevista debe ser posterior a la fecha del sistema.", "danger")
        return redirect(url_for('general_settings'))
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET fecha_prevista = ? WHERE id = 1', (planned_str,))
    conn.execute("DELETE FROM ordenes_trabajo WHERE estado = 'Prevista'")
    actividades = conn.execute('SELECT * FROM actividades').fetchall()
    count_generated = 0
    for act in actividades:
        # LÓGICA DE CONTROL: Si la actividad tiene generar_ot desactivado, saltamos
        if not act['generar_ot']:
            continue

        f_inicio = datetime.datetime.strptime(act['fecha_inicio_gen'], '%Y-%m-%d').date()
        periodicity = act['periodicidad']
        if f_inicio > system_date: current_calc = f_inicio
        else:
            delta_days = (system_date - f_inicio).days
            periods_passed = delta_days // periodicity
            current_calc = f_inicio + datetime.timedelta(days=(periods_passed + 1) * periodicity)
        while current_calc <= planned_date:
             if not conn.execute('SELECT id FROM ordenes_trabajo WHERE actividad_id=? AND fecha_generacion=?', (act['id'], current_calc)).fetchone():
                 nombre_ot = f"{act['nombre']} - {current_calc.strftime('%d/%m/%Y')}"
                 # Modified Logic: Based on Month/Year strict comparison
                 if current_calc.year < system_date.year or (current_calc.year == system_date.year and current_calc.month < system_date.month):
                     st = 'Pendiente'
                 elif current_calc.year == system_date.year and current_calc.month == system_date.month:
                     st = 'En curso'
                 else:
                     st = 'Prevista'
                     
                 conn.execute('INSERT INTO ordenes_trabajo (actividad_id, nombre, fecha_generacion, estado) VALUES (?,?,?,?)', 
                              (act['id'], nombre_ot, current_calc, st))
                 count_generated += 1
             current_calc += datetime.timedelta(days=periodicity)
    conn.commit()
    conn.close()
    utils.log_action(f"Plan regenerado: {count_generated} OTs.")
    flash(f"Plan actualizado. Generadas {count_generated} OTs.", "success")
    return redirect(url_for('general_settings'))

@app.route('/system_date_config/update', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_system_date():
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET fecha_sistema=? WHERE id=1', (request.form['fecha_sistema'],))
    conn.commit()
    conn.close()
    return redirect(url_for('general_settings'))

@app.route('/settings/toggle_logging', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def toggle_logging():
    enabled = 1 if 'logging_enabled' in request.form else 0
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET logging_enabled = ? WHERE id = 1', (enabled,))
    conn.commit()
    conn.close()
    flash(f"Logging {'activado' if enabled else 'desactivado'}", "success")
    return redirect(url_for('general_settings'))

@app.route('/settings/download_log')
@utils.login_required
@utils.permission_required('perm_configuracion')
def download_log():
    if os.path.exists(utils.LOG_FILE): return send_file(utils.LOG_FILE, as_attachment=True)
    flash("Log vacío.", "warning"); return redirect(url_for('general_settings'))

@app.route('/settings/backup_db')
@utils.login_required
@utils.permission_required('perm_configuracion')
def backup_db():
    db_file = db.DB_NAME # 'mantenimiento_factory.db'
    if not os.path.exists(db_file):
        flash("No se encuentra la base de datos.", "danger")
        return redirect(url_for('general_settings'))
    
    timestamp = datetime.datetime.now().strftime('%Y-%m-%d_%H-%M-%S')
    backup_name = f"backup_mantenimiento_{timestamp}.bak"
    
    utils.log_action("Descargada copia de seguridad de la BD")
    return send_file(db_file, as_attachment=True, download_name=backup_name)

# RUTA NUEVA: RESTAURAR COPIA DE SEGURIDAD
@app.route('/settings/restore_db', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def restore_db():
    if 'db_file' not in request.files:
        flash('No se seleccionó ningún archivo', 'danger')
        return redirect(url_for('general_settings'))
    
    file = request.files['db_file']
    if file.filename == '':
        flash('No se seleccionó ningún archivo', 'danger')
        return redirect(url_for('general_settings'))

    if file and utils.allowed_file_db(file.filename):
        try:
            # 1. Guardar archivo temporal
            temp_path = "restore_temp.db"
            file.save(temp_path)
            
            # 2. Verificar que es una BD SQLite válida
            try:
                verify_conn = sqlite3.connect(temp_path)
                verify_conn.execute("SELECT name FROM sqlite_master WHERE type='table'")
                verify_conn.close()
            except sqlite3.Error:
                os.remove(temp_path)
                flash('El archivo subido no es una base de datos SQLite válida o está corrupto.', 'danger')
                return redirect(url_for('general_settings'))

            # 3. Sustituir la base de datos actual
            # Hacemos un backup rápido de la actual por si falla el move (solo un renombrado)
            current_db = db.DB_NAME
            backup_fail_safe = current_db + ".restore_backup"
            
            if os.path.exists(current_db):
                shutil.move(current_db, backup_fail_safe)
            
            try:
                shutil.move(temp_path, current_db)
                # Si todo ha ido bien, borramos el backup de seguridad
                if os.path.exists(backup_fail_safe):
                    os.remove(backup_fail_safe)
                    
                utils.log_action("Base de datos restaurada desde copia de seguridad")
                flash('Base de datos restaurada con éxito. Por seguridad, inicie sesión nuevamente.', 'success')
                return redirect(url_for('logout'))
                
            except Exception as e:
                # Si falla mover el nuevo archivo, restauramos el original
                if os.path.exists(backup_fail_safe):
                    shutil.move(backup_fail_safe, current_db)
                raise e

        except Exception as e:
            flash(f'Error al restaurar la base de datos: {str(e)}', 'danger')
            return redirect(url_for('general_settings'))
    else:
        flash('Formato de archivo no válido. Use .db, .sqlite o .bak', 'danger')
        return redirect(url_for('general_settings'))

@app.route('/users/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def add_user():
    try:
        pw_hash = generate_password_hash(request.form['password'])
        p_inv = 1 if 'perm_inventario' in request.form else 0
        p_act = 1 if 'perm_actividades' in request.form else 0
        p_conf = 1 if 'perm_configuracion' in request.form else 0
        conn = db.get_db_connection()
        conn.execute('INSERT INTO usuarios (username, password_hash, rol, perm_inventario, perm_actividades, perm_configuracion) VALUES (?,?,?,?,?,?)',
                     (request.form['username'], pw_hash, request.form['rol'], p_inv, p_act, p_conf))
        conn.commit()
        conn.close()
        utils.log_action(f"Usuario creado: {request.form['username']}")
        flash('Usuario creado', 'success')
    except: flash('Error al crear usuario', 'danger')
    return redirect(url_for('general_settings'))

@app.route('/users/edit/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def edit_user(id):
    p_inv = 1 if 'perm_inventario' in request.form else 0
    p_act = 1 if 'perm_actividades' in request.form else 0
    p_conf = 1 if 'perm_configuracion' in request.form else 0
    conn = db.get_db_connection()
    if request.form['password']:
        pw = generate_password_hash(request.form['password'])
        conn.execute('UPDATE usuarios SET rol=?, perm_inventario=?, perm_actividades=?, perm_configuracion=?, password_hash=? WHERE id=?', (request.form['rol'], p_inv, p_act, p_conf, pw, id))
    else:
        conn.execute('UPDATE usuarios SET rol=?, perm_inventario=?, perm_actividades=?, perm_configuracion=? WHERE id=?', (request.form['rol'], p_inv, p_act, p_conf, id))
    conn.commit()
    conn.close()
    utils.log_action(f"Usuario editado: ID {id}")
    flash('Usuario actualizado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/users/delete/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def delete_user(id):
    conn = db.get_db_connection()
    conn.execute('DELETE FROM usuarios WHERE id=?', (id,))
    conn.commit()
    conn.close()
    utils.log_action(f"Usuario eliminado: ID {id}")
    flash('Usuario eliminado', 'success')
    return redirect(url_for('general_settings'))

@app.route('/configuration/type/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def add_type_config():
    try:
        conn = db.get_db_connection()
        conn.execute('INSERT INTO tipos_equipo (nombre) VALUES (?)', (request.form['nombre'],))
        conn.commit()
        conn.close()
        utils.log_action(f"Tipo creado: {request.form['nombre']}")
    except: pass
    return redirect(url_for('general_settings'))

@app.route('/configuration/type/edit/<int:id>')
@utils.login_required
@utils.permission_required('perm_configuracion')
def edit_type(id):
    conn = db.get_db_connection()
    tipo = conn.execute('SELECT * FROM tipos_equipo WHERE id=?', (id,)).fetchone()
    conn.close()
    return render_template('settings/edit_type.html', tipo=tipo, active_page='ajustes', system_date=utils.get_system_date())

@app.route('/configuration/type/update/<int:id>', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_configuracion')
def update_type(id):
    try:
        conn = db.get_db_connection()
        conn.execute('UPDATE tipos_equipo SET nombre=? WHERE id=?', (request.form['nombre'], id))
        conn.commit()
        conn.close()
    except: pass
    return redirect(url_for('general_settings'))

# NUEVA RUTA DE AYUDA
@app.route('/help')
@utils.login_required
def help_page():
    return render_template('help.html', active_page='help', system_date=utils.get_system_date())

@app.route('/about')
def about():
    return render_template('about.html', active_page='about', system_date=utils.get_system_date())

@app.route('/types/add', methods=['POST'])
@utils.login_required
@utils.permission_required('perm_inventario')
def add_type():
    try:
        conn = db.get_db_connection()
        conn.execute('INSERT INTO tipos_equipo (nombre) VALUES (?)', (request.form['nombre'],))
        conn.commit()
        conn.close()
    except: pass
    return redirect(url_for('inventory'))

# ==========================================
# RUTAS NUEVAS PARA EL CALENDARIO (COLORES ACTUALIZADOS)
# ==========================================

@app.route('/calendar')
@utils.login_required
def calendar_view():
    return render_template('calendar/index.html', active_page='calendario', system_date=utils.get_system_date())

@app.route('/api/calendar_events')
@utils.login_required
def get_calendar_events():
    conn = db.get_db_connection()
    ots = conn.execute('SELECT id, nombre, fecha_generacion, estado, observaciones FROM ordenes_trabajo').fetchall()
    conn.close()
    
    events = []
    for ot in ots:
        color = '#6c757d' # Default
        estado = ot['estado']
        
        if estado == 'Pendiente': color = '#dc3545'      # Rojo
        elif estado == 'En curso': color = '#ffc107'     # Amarillo
        elif estado == 'Realizada': color = '#28a745'    # Verde
        elif estado == 'Prevista': color = '#6c757d'     # Gris
        elif estado == 'Aplazada': color = '#6f42c1'     # Violeta
        elif estado == 'Rechazada': color = '#000000'    # Negra
        
        events.append({
            'id': ot['id'],
            'title': ot['nombre'],
            'start': ot['fecha_generacion'],
            'color': color,
            'url': url_for('work_orders'),
            'extendedProps': {
                'estado': estado,
                'observaciones': ot['observaciones'] or ''
            }
        })
        
    return json.dumps(events)

if __name__ == '__main__':
    if not os.path.exists('mantenimiento_factory.db'):
        db.init_db()
    db.init_db()
    utils.create_default_admin()
    print("Sincronizando fecha del sistema...")
    try:
        conn = db.get_db_connection()
        real_today = datetime.date.today()
        # Usamos .isoformat() para convertir el objeto fecha a texto "YYYY-MM-DD"
        conn.execute('UPDATE configuracion SET fecha_sistema=? WHERE id=1', (real_today.isoformat(),))
        count = utils.generate_and_update_work_orders(conn, real_today)
        conn.commit()
        conn.close()
        print(f"Sistema sincronizado a {real_today}. OTs procesadas: {count}")
    except Exception as e: print(f"Error en sincronización inicial: {e}")
    print("Iniciando Sistema GMAO...")
    print("Accesible en tu red local. Busca tu IP (ej: ipconfig o ifconfig)")
    ## app.run(debug=True, port=5000, host='0.0.0.0')
    serve(app, port=5000, host='0.0.0.0')
--- FIN ARCHIVO: contexto_proyecto.txt ---

--- INICIO ARCHIVO: database.py ---
import sqlite3
import datetime

DB_NAME = 'mantenimiento_factory.db'

def get_db_connection():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db_connection()
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS tipos_equipo (id INTEGER PRIMARY KEY AUTOINCREMENT, nombre TEXT UNIQUE NOT NULL)''')
    c.execute('''CREATE TABLE IF NOT EXISTS inventario (id INTEGER PRIMARY KEY AUTOINCREMENT, nombre TEXT NOT NULL, tipo_id INTEGER NOT NULL, descripcion TEXT, images TEXT, pdfs TEXT, FOREIGN KEY (tipo_id) REFERENCES tipos_equipo (id))''')
    # MODIFICACIÓN: Añadimos el campo generar_ot a la creación de tabla
    c.execute('''CREATE TABLE IF NOT EXISTS actividades (
        id INTEGER PRIMARY KEY AUTOINCREMENT, 
        nombre TEXT NOT NULL, 
        equipo_id INTEGER NOT NULL, 
        periodicidad INTEGER NOT NULL, 
        operaciones TEXT, 
        fecha_inicio_gen DATE NOT NULL,
        generar_ot INTEGER DEFAULT 1,
        FOREIGN KEY (equipo_id) REFERENCES inventario (id)
    )''')
    c.execute('''CREATE TABLE IF NOT EXISTS ordenes_trabajo (id INTEGER PRIMARY KEY AUTOINCREMENT, actividad_id INTEGER NOT NULL, nombre TEXT NOT NULL, fecha_generacion DATE NOT NULL, estado TEXT NOT NULL DEFAULT 'En curso', observaciones TEXT, fecha_realizada DATE, FOREIGN KEY (actividad_id) REFERENCES actividades (id))''')
    c.execute('''CREATE TABLE IF NOT EXISTS correctivos (id INTEGER PRIMARY KEY AUTOINCREMENT, nombre TEXT NOT NULL, equipo_id INTEGER NOT NULL, comentario TEXT, solucion TEXT, estado TEXT NOT NULL DEFAULT 'Detectada', fecha_detectada DATE NOT NULL, fecha_resolucion DATE, images TEXT, pdfs TEXT, FOREIGN KEY (equipo_id) REFERENCES inventario (id))''')
    c.execute('''CREATE TABLE IF NOT EXISTS configuracion (id INTEGER PRIMARY KEY, fecha_sistema DATE, logging_enabled INTEGER DEFAULT 0, fecha_prevista DATE, fecha_inicio_resumen DATE, fecha_fin_resumen DATE, nombre_mantenimiento TEXT DEFAULT 'GMAO Factory')''')
    c.execute('''CREATE TABLE IF NOT EXISTS usuarios (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE NOT NULL, password_hash TEXT NOT NULL, rol TEXT, perm_inventario INTEGER DEFAULT 0, perm_actividades INTEGER DEFAULT 0, perm_configuracion INTEGER DEFAULT 0)''')
    
    try: c.execute("ALTER TABLE configuracion ADD COLUMN logging_enabled INTEGER DEFAULT 0")
    except: pass 
    try: c.execute("ALTER TABLE configuracion ADD COLUMN fecha_prevista DATE")
    except: pass
    try: c.execute("ALTER TABLE configuracion ADD COLUMN fecha_inicio_resumen DATE")
    except: pass
    try: c.execute("ALTER TABLE configuracion ADD COLUMN fecha_fin_resumen DATE")
    except: pass
    try: c.execute("ALTER TABLE actividades ADD COLUMN generar_ot INTEGER DEFAULT 1")
    except: pass
    # NUEVA MIGRACIÓN: Nombre del Mantenimiento
    try: c.execute("ALTER TABLE configuracion ADD COLUMN nombre_mantenimiento TEXT DEFAULT 'GMAO Factory'")
    except: pass

    today = datetime.date.today()
    next_year = today + datetime.timedelta(days=365)
    try: c.execute("UPDATE configuracion SET fecha_prevista = ? WHERE id=1 AND fecha_prevista IS NULL", (next_year,))
    except: pass
    try: c.execute("INSERT INTO configuracion (id, fecha_sistema, logging_enabled, fecha_prevista, nombre_mantenimiento) VALUES (1, ?, 0, ?, 'GMAO Factory')", (today, next_year))
    except sqlite3.IntegrityError: pass
    
    defaults = ['Obra Civil', 'Instalaciones Eléctricas', 'Instalaciones Hidráulicas']
    for d in defaults:
        try: c.execute("INSERT INTO tipos_equipo (nombre) VALUES (?)", (d,))
        except: pass
    conn.commit()
    conn.close()
--- FIN ARCHIVO: database.py ---

--- INICIO ARCHIVO: Empaquetador_de_Proyectos.py ---
import os

def pack_project(output_file="contexto_proyecto.txt"):
    # Directorios y archivos que queremos ignorar para no saturar a la IA
    ignore_list = {
        '__pycache__', '.git', '.venv', 'venv', 'env', 
        '.pytest_cache', '.vscode', '.idea', 'dist', 'build',
        'node_modules', '.DS_Store','static'
    }
    
    # Extensiones de archivos que queremos incluir
    include_extensions = {'.py', '.md', '.txt', '.html', '.css', '.js', '.json', '.yaml', '.yml', '.sql'}

    with open(output_file, 'w', encoding='utf-8') as f_out:
        f_out.write("ESTRUCTURA DEL PROYECTO:\n")
        
        # Primero generamos un árbol visual rápido de las carpetas
        for root, dirs, files in os.walk('.'):
            dirs[:] = [d for d in dirs if d not in ignore_list]
            level = root.replace('.', '').count(os.sep)
            indent = ' ' * 4 * level
            f_out.write(f"{indent}{os.path.basename(root)}/\n")
            sub_indent = ' ' * 4 * (level + 1)
            for f in files:
                if any(f.endswith(ext) for ext in include_extensions):
                    f_out.write(f"{sub_indent}{f}\n")
        
        f_out.write("\n" + "="*50 + "\n")
        f_out.write("CONTENIDO DE LOS ARCHIVOS:\n")
        f_out.write("="*50 + "\n\n")

        # Ahora recorremos y volcamos el contenido de cada archivo
        for root, dirs, files in os.walk('.'):
            dirs[:] = [d for d in dirs if d not in ignore_list]
            
            for file in files:
                if any(file.endswith(ext) for ext in include_extensions):
                    file_path = os.path.join(root, file)
                    relative_path = os.path.relpath(file_path, '.')
                    
                    try:
                        with open(file_path, 'r', encoding='utf-8') as f_in:
                            content = f_in.read()
                            f_out.write(f"--- INICIO ARCHIVO: {relative_path} ---\n")
                            f_out.write(content)
                            f_out.write(f"\n--- FIN ARCHIVO: {relative_path} ---\n\n")
                    except Exception as e:
                        f_out.write(f"Error leyendo {relative_path}: {e}\n")

    print(f"✅ Proyecto empaquetado con éxito en: {output_file}")

if __name__ == "__main__":
    pack_project()
--- FIN ARCHIVO: Empaquetador_de_Proyectos.py ---

--- INICIO ARCHIVO: requirements.txt ---
Flask==3.1.2
waitress==3.0.2
Werkzeug==3.1.5

--- FIN ARCHIVO: requirements.txt ---

--- INICIO ARCHIVO: resumen.py ---
from flask import Blueprint, render_template, request, redirect, url_for
import database as db
import utils
import datetime
import json

resumen_bp = Blueprint('resumen', __name__)

@resumen_bp.route('/')
@utils.login_required
def index():
    conn = db.get_db_connection()
    
    config = conn.execute('SELECT fecha_inicio_resumen, fecha_fin_resumen FROM configuracion WHERE id=1').fetchone()
    today = utils.get_system_date()
    
    if config and config['fecha_inicio_resumen']: fecha_inicio = config['fecha_inicio_resumen']
    else: fecha_inicio = (today - datetime.timedelta(days=365)).strftime('%Y-%m-%d')
    if config and config['fecha_fin_resumen']: fecha_fin = config['fecha_fin_resumen']
    else: fecha_fin = today.strftime('%Y-%m-%d')

    estados_ot_orden = ['Realizada', 'En curso', 'Pendiente', 'Prevista', 'Aplazada', 'Rechazada']
    values_ot = []
    total_ots = 0
    for estado in estados_ot_orden:
        count = conn.execute("SELECT COUNT(*) FROM ordenes_trabajo WHERE fecha_generacion BETWEEN ? AND ? AND estado = ?", (fecha_inicio, fecha_fin, estado)).fetchone()[0]
        values_ot.append(count)
        total_ots += count
    
    estados_corr_orden = ['Detectada', 'En curso', 'Resuelta']
    values_corr = []
    total_corr = 0
    for estado in estados_corr_orden:
        count = conn.execute("SELECT COUNT(*) FROM correctivos WHERE fecha_detectada BETWEEN ? AND ? AND estado = ?", (fecha_inicio, fecha_fin, estado)).fetchone()[0]
        values_corr.append(count)
        total_corr += count

    # NEW: Fetch actual data for tables
    ots_query = """
        SELECT ot.id, ot.nombre, ot.fecha_generacion, ot.estado, i.nombre as equipo_nombre
        FROM ordenes_trabajo ot
        JOIN actividades a ON ot.actividad_id = a.id
        JOIN inventario i ON a.equipo_id = i.id
        WHERE ot.fecha_generacion BETWEEN ? AND ?
        ORDER BY ot.fecha_generacion DESC
    """
    ots = conn.execute(ots_query, (fecha_inicio, fecha_fin)).fetchall()

    corr_query = """
        SELECT c.id, c.nombre, c.fecha_detectada, c.estado, i.nombre as equipo_nombre
        FROM correctivos c
        JOIN inventario i ON c.equipo_id = i.id
        WHERE c.fecha_detectada BETWEEN ? AND ?
        ORDER BY c.fecha_detectada DESC
    """
    correctivos = conn.execute(corr_query, (fecha_inicio, fecha_fin)).fetchall()

    conn.close()

    return render_template('resumen/index.html', active_page='resumen', system_date=utils.get_system_date(),
        fecha_inicio=fecha_inicio, fecha_fin=fecha_fin,
        labels_ot=json.dumps(estados_ot_orden), values_ot=json.dumps(values_ot),
        labels_corr=json.dumps(estados_corr_orden), values_corr=json.dumps(values_corr),
        total_ots=total_ots, total_corr=total_corr,
        ots=ots, correctivos=correctivos)

@resumen_bp.route('/update_dates', methods=['POST'])
@utils.login_required
def update_dates():
    f_inicio = request.form['fecha_inicio']
    f_fin = request.form['fecha_fin']
    conn = db.get_db_connection()
    conn.execute('UPDATE configuracion SET fecha_inicio_resumen=?, fecha_fin_resumen=? WHERE id=1', (f_inicio, f_fin))
    conn.commit()
    conn.close()
    return redirect(url_for('resumen.index'))
--- FIN ARCHIVO: resumen.py ---

--- INICIO ARCHIVO: utils.py ---
import base64
import json
import datetime
import os
from functools import wraps
from flask import session, redirect, url_for, flash
from werkzeug.security import generate_password_hash
from database import get_db_connection
from dateutil.relativedelta import relativedelta

LOG_FILE = 'gmao_app.log'

def create_default_admin():
    conn = get_db_connection()
    user = conn.execute('SELECT * FROM usuarios WHERE username = ?', ('Administrador',)).fetchone()
    if not user:
        pw_hash = generate_password_hash('123456')
        conn.execute('INSERT INTO usuarios (username, password_hash, rol, perm_inventario, perm_actividades, perm_configuracion) VALUES (?, ?, ?, ?, ?, ?)', ('Administrador', pw_hash, 'Admin', 1, 1, 1))
        conn.commit()
    conn.close()

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session: return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def permission_required(perm):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not session.get(perm):
                flash("No tienes permisos.", "danger")
                return redirect(url_for('index'))
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def get_system_date():
    try:
        conn = get_db_connection()
        row = conn.execute('SELECT fecha_sistema FROM configuracion WHERE id=1').fetchone()
        conn.close()
        if row and row['fecha_sistema']: return datetime.datetime.strptime(row['fecha_sistema'], '%Y-%m-%d').date()
    except: pass
    return datetime.date.today()

def get_planned_date():
    try:
        conn = get_db_connection()
        row = conn.execute('SELECT fecha_prevista FROM configuracion WHERE id=1').fetchone()
        conn.close()
        if row and row['fecha_prevista']: return datetime.datetime.strptime(row['fecha_prevista'], '%Y-%m-%d').date()
    except: pass
    return None

# NUEVA FUNCIÓN: Obtener nombre del mantenimiento
def get_maintenance_name():
    try:
        conn = get_db_connection()
        row = conn.execute('SELECT nombre_mantenimiento FROM configuracion WHERE id=1').fetchone()
        conn.close()
        if row and row['nombre_mantenimiento']: return row['nombre_mantenimiento']
    except: pass
    return "GMAO Factory"

def is_logging_enabled():
    try:
        conn = get_db_connection()
        row = conn.execute('SELECT logging_enabled FROM configuracion WHERE id=1').fetchone()
        conn.close()
        if row: return bool(row['logging_enabled'])
    except: pass
    return False

def log_action(action_message):
    if is_logging_enabled():
        timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        try:
            user = session.get('username', 'Sistema')
            with open(LOG_FILE, 'a', encoding='utf-8') as f: f.write(f"[{timestamp}] [{user}] {action_message}\n")
        except: pass

def allowed_file_image(filename): return '.' in filename and filename.rsplit('.', 1)[1].lower() in {'png', 'jpg', 'jpeg', 'gif'}
def allowed_file_pdf(filename): return '.' in filename and filename.rsplit('.', 1)[1].lower() in {'pdf'}
def allowed_file_db(filename): return '.' in filename and filename.rsplit('.', 1)[1].lower() in {'db', 'bak', 'sqlite', 'sqlite3'}
def file_to_base64(file): return base64.b64encode(file.read()).decode('utf-8')

def normalize_files(file_list):
    normalized = []
    if not file_list: return []
    for item in file_list:
        if isinstance(item, str): normalized.append({'name': 'Archivo Legacy', 'data': item})
        elif isinstance(item, dict): normalized.append(item)
    return normalized

def json_load_filter(s):
    if not s: return []
    try: return json.loads(s) if isinstance(s, str) else s
    except: return []

def get_cronograma_data(conn, year):
    actividades = conn.execute('SELECT a.id, a.nombre, i.nombre as equipo_nombre FROM actividades a JOIN inventario i ON a.equipo_id = i.id').fetchall()
    cronograma_data = []
    for act in actividades:
        row = {'actividad': act['nombre'], 'equipo': act['equipo_nombre'], 'ots': {}}
        ots = conn.execute('SELECT ot.id, ot.nombre, ot.fecha_generacion, ot.estado, ot.observaciones, ot.fecha_realizada, a.operaciones FROM ordenes_trabajo ot JOIN actividades a ON ot.actividad_id = a.id WHERE ot.actividad_id = ? AND strftime("%Y", ot.fecha_generacion) = ?', (act['id'], str(year))).fetchall()
        for ot in ots:
            fecha = datetime.datetime.strptime(ot['fecha_generacion'], '%Y-%m-%d')
            mes_idx = fecha.month
            if mes_idx not in row['ots']: row['ots'][mes_idx] = []
            row['ots'][mes_idx].append({'id': ot['id'], 'nombre': ot['nombre'], 'estado': ot['estado'], 'day_day': fecha.day, 'fecha': ot['fecha_generacion'], 'operaciones': ot['operaciones'], 'observaciones': ot['observaciones'], 'fecha_realizada': ot['fecha_realizada']})
        cronograma_data.append(row)
    return cronograma_data

def generate_and_update_work_orders(conn, current_system_date):
    row = conn.execute('SELECT fecha_prevista FROM configuracion WHERE id=1').fetchone()
    planned_date = datetime.datetime.strptime(row['fecha_prevista'], '%Y-%m-%d').date() if row and row['fecha_prevista'] else None
    generation_limit = current_system_date
    if planned_date and planned_date > current_system_date: generation_limit = planned_date
    
    actividades = conn.execute('SELECT * FROM actividades').fetchall()
    count_generated = 0
    
    for act in actividades:
        if not act['generar_ot']:
            conn.execute("DELETE FROM ordenes_trabajo WHERE actividad_id=? AND estado='Prevista'", (act['id'],))
            continue

        f = datetime.datetime.strptime(act['fecha_inicio_gen'], '%Y-%m-%d').date()
        p = act['periodicidad']
        while f <= generation_limit:
            if not conn.execute('SELECT id FROM ordenes_trabajo WHERE actividad_id=? AND fecha_generacion=?', (act['id'], f)).fetchone():
                if f.year < current_system_date.year or (f.year == current_system_date.year and f.month < current_system_date.month):
                    st = 'Pendiente'
                elif f.year == current_system_date.year and f.month == current_system_date.month:
                    st = 'En curso'
                else:
                    st = 'Prevista'
                    
                conn.execute('INSERT INTO ordenes_trabajo (actividad_id, nombre, fecha_generacion, estado) VALUES (?,?,?,?)', 
                             (act['id'], f"{act['nombre']} - {f.strftime('%d/%m/%Y')}", f, st))
                count_generated += 1
            if p % 30 == 0:
                # apicable cuando el periodo es divisible entre 30 (mes=30 dias, dos meses= 60 dias, etc.)
                f += relativedelta(months=p/30)
            else:
                #cualquier otro numero de dias
                f += datetime.timedelta(days=p) 
            
    active_ots = conn.execute("SELECT ot.id, ot.fecha_generacion, ot.estado FROM ordenes_trabajo ot WHERE ot.estado NOT IN ('Realizada', 'Rechazada', 'Aplazada') OR ot.estado IS NULL").fetchall()
    
    for ot in active_ots:
        if not ot['fecha_generacion']: continue
        gen = datetime.datetime.strptime(ot['fecha_generacion'], '%Y-%m-%d').date()
        
        if gen.year < current_system_date.year or (gen.year == current_system_date.year and gen.month < current_system_date.month):
            new_state = 'Pendiente'
        elif gen.year == current_system_date.year and gen.month == current_system_date.month:
            new_state = 'En curso'
        else:
            new_state = 'Prevista'
            
        if new_state != ot['estado']: 
            conn.execute("UPDATE ordenes_trabajo SET estado = ? WHERE id = ?", (new_state, ot['id']))
            
    return count_generated
--- FIN ARCHIVO: utils.py ---

--- INICIO ARCHIVO: templates\about.html ---
{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h3 class="mb-0"><i class="fas fa-info-circle me-2"></i> Acerca de...</h3>
        </div>
        <div class="card-body p-5 text-center">
            <h1 class="display-4 mb-4">GMAO Factory</h1>
            <hr class=\"w-50 mx-auto mb-4\">
            <div class=\"row justify-content-center\">
                <div class=\"col-md-8 text-start\">
                    <dl class=\"row font-monospace fs-5\">
                        <dt class=\"col-sm-4 text-end\">Programa:</dt>
                        <dd class=\"col-sm-8\">Sistema de Gestión de Mantenimiento Asistido por Ordenador</dd>
                        <dt class=\"col-sm-4 text-end\">Versión:</dt>
                        <dd class=\"col-sm-8\"><span class=\"badge bg-primary\">v7.10</span></dd>
                        <dt class=\"col-sm-4 text-end\">Autor:</dt>
                        <dd class=\"col-sm-8\">Julio Sánchez Berro</dd>
                        <dt class=\"col-sm-4 text-end\">Licencia:</dt>
                        <dd class=\"col-sm-8\">GPL 3.0</dd>
                    </dl>
                </div>
            </div>
            <div class=\"mt-5\">
                <p class=\"text-muted\">Gestión integral de activos, planes de mantenimiento preventivo y control de
                    incidencias.</p><small class=\"text-muted\"> Sevilla, España &copy; {{ system_date.year }}</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\about.html ---

--- INICIO ARCHIVO: templates\base.html ---
<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ maintenance_name }}</title>
     <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

    <!-- Script preventivo para evitar destellos de luz al cargar si el modo oscuro está activo -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('gmao-theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
        })();
    </script>

    <!-- Estilos Locales (Bootstrap, FontAwesome, DataTables) -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/datatables.min.css') }}" rel="stylesheet">

    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --sidebar-active-border: #3498db;
        }

        [data-bs-theme="dark"] {
            --sidebar-bg: #1a1d20;
            --sidebar-hover: #2b3035;
            --sidebar-active-border: #0d6efd;
        }

        .sidebar-container { background-color: var(--sidebar-bg); color: white; min-height: 100vh; transition: background-color 0.3s; }
        .sidebar-link { color: #bdc3c7; text-decoration: none; display: block; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-link:hover, .sidebar-link.active { background-color: var(--sidebar-hover); color: white; border-left: 4px solid var(--sidebar-active-border); }
        
        /* Forzamos el color blanco en la cabecera de la sidebar siempre */
        .sidebar-brand { padding: 20px; text-align: center; background-color: rgba(0,0,0,0.2); margin-bottom: 10px; color: white !important; }
        .sidebar-brand h4, 
        .sidebar-brand small, 
        .sidebar-brand .text-muted { 
            color: white !important; 
        }

        .content { padding: 20px; }
        .mobile-navbar { background-color: var(--sidebar-bg); }
        .dataTables_length, .dataTables_filter { margin-bottom: 1rem; }
        
        /* Tema del Toggle */
        .theme-toggle-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.2);
            color: #bdc3c7;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle-btn:hover { color: white; border-color: white; }

        /* Estilo manual para checkboxes DataTables Select */
        table.dataTable tbody td.select-checkbox,
        table.dataTable tbody th.select-checkbox {
            position: relative;
        }
        table.dataTable tbody td.select-checkbox:before,
        table.dataTable tbody th.select-checkbox:before {
            content: ' ';
            margin-top: -6px;
            margin-left: -6px;
            border: 1px solid #888;
            border-radius: 3px;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            box-sizing: border-box;
        }
        [data-bs-theme="dark"] table.dataTable tbody td.select-checkbox:before { border-color: #666; }

        table.dataTable tr.selected td.select-checkbox:after,
        table.dataTable tr.selected th.select-checkbox:after {
            content: '✓';
            font-size: 20px;
            margin-top: -19px;
            margin-left: -6px;
            text-align: center;
            text-shadow: 1px 1px #B0BED9, -1px -1px #B0BED9, 1px -1px #B0BED9, -1px 1px #B0BED9;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
        }

        /* ----------------------------------------------------------- */
        /* AJUSTE FINAL: TÍTULOS Y TABLAS SIEMPRE ESTILO CLARO         */
        /* ----------------------------------------------------------- */
        
        /* Forzamos que cabeceras de tablas, celdas laterales, cabeceras de tarjetas y bloques bg-light
           tengan FONDO CLARO y TEXTO OSCURO siempre */
        .table thead th, 
        .cron-sidebar-col, 
        .card-header, 
        .card-header *,
        .bg-light,
        .bg-light *,
        .table-light,
        .table-light * {
            background-color: #f8f9fa !important;
            color: #212529 !important;
            border-bottom-color: #dee2e6 !important;
        }

        /* En bloques forzados a ser claros, aseguramos que el texto muted sea legible */
        .cron-sidebar-col .text-muted,
        .bg-light .text-muted,
        .table-light .text-muted {
            color: #6c757d !important;
        }

        /* Los títulos H1-H6 fuera de tablas/cards sí deben adaptarse al modo oscuro para no desentonar */
        [data-bs-theme="dark"] h1, [data-bs-theme="dark"] h2, [data-bs-theme="dark"] h3,
        [data-bs-theme="dark"] h5, [data-bs-theme="dark"] h6 {
            color: #f8f9fa;
        }
        /* Excepción específica para H4 que suele usarse en la sidebar */
        [data-bs-theme="dark"] h4:not(.sidebar-container h4) { color: #f8f9fa; }

        /* En modo claro deben ser oscuros, excepto en la sidebar */
        [data-bs-theme="light"] h1, [data-bs-theme="light"] h2, [data-bs-theme="light"] h3,
        [data-bs-theme="light"] h5, [data-bs-theme="light"] h6 {
            color: #212529;
        }
        [data-bs-theme="light"] h4:not(.sidebar-container h4) { color: #212529; }
        
        /* Aseguramos que el cuerpo de la tarjeta sea legible en modo oscuro */
        [data-bs-theme="dark"] .card {
            background-color: #2b3035;
            border-color: #373b3e;
        }
        /* ----------------------------------------------------------- */
        
        /* ESTADOS */
        .status-realizada, .corr-resuelta { background-color: #198754; color: white; }
        .status-en-curso, .corr-en-curso { background-color: #ffc107; color: #212529; }
        .status-rechazada { background-color: #000000; color: white; }
        .status-pendiente, .corr-detectada { background-color: #dc3545; color: white; }
        .status-prevista { background-color: #6c757d; color: white; }
        .status-aplazada { background-color: #6f42c1; color: white; }
        
        .badge-status { font-size: 0.8em; padding: 5px; border-radius: 4px; display: inline-block; margin-bottom: 2px; cursor: pointer; transition: transform 0.1s; }
        .badge-status:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
   
</head>
<body>
    {% macro render_navigation() %}
        <div class="sidebar-brand">
            <!-- NOMBRE DEL MANTENIMIENTO DINÁMICO -->
            <h4>{{ maintenance_name }}</h4>
            <small>🏭 GMAO Factory v7.10</small>
            <div class="mt-2">
                <button class="theme-toggle-btn">
                    <i class="fas fa-moon me-1"></i> <span class="theme-text">Modo Oscuro</span>
                </button>
            </div>
            <div class="mt-2 small text-muted">Usuario: {{ session.get('username', 'Invitado') }}</div>
        </div>
        <div>
            <a href="{{ url_for('resumen.index') }}" class="sidebar-link {{ 'active' if active_page == 'resumen' else '' }}"><i class="fas fa-chart-pie me-2"></i> Resumen</a>
            {% if session.get('perm_inventario') %}
            <a href="{{ url_for('inventory') }}" class="sidebar-link {{ 'active' if active_page == 'inventario' else '' }}"><i class="fas fa-boxes me-2"></i> Inventario</a>
            {% endif %}
            {% if session.get('perm_actividades') %}
            <a href="{{ url_for('activities') }}" class="sidebar-link {{ 'active' if active_page == 'actividades' else '' }}"><i class="fas fa-clipboard-list me-2"></i> Actividades</a>
            {% endif %}
            <a href="{{ url_for('work_orders') }}" class="sidebar-link {{ 'active' if active_page == 'ots' else '' }}"><i class="fas fa-tools me-2"></i> Órdenes de Trabajo</a>
            <a href="{{ url_for('cronograma') }}" class="sidebar-link {{ 'active' if active_page == 'cronograma' else '' }}"><i class="fas fa-calendar-alt me-2"></i> Cronogramas OTs</a>
            <a href="{{ url_for('calendar_view') }}" class="sidebar-link {{ 'active' if active_page == 'calendario' else '' }}"><i class="fas fa-calendar me-2"></i> Calendario</a>
            
            <a href="{{ url_for('correctivos') }}" class="sidebar-link {{ 'active' if active_page == 'correctivos' else '' }}"><i class="fas fa-exclamation-triangle me-2"></i> Correctivos</a>
            {% if session.get('perm_configuracion') %}
            <div class="border-top border-secondary my-2"></div>
            <a href="{{ url_for('general_settings') }}" class="sidebar-link {{ 'active' if active_page == 'ajustes' else '' }}"><i class="fas fa-cog me-2"></i> Configuración Global</a>
            {% endif %}
            <div class="border-top border-secondary my-2"></div>
            
            <!-- NUEVO LINK: AYUDA -->
            <a href="{{ url_for('help_page') }}" class="sidebar-link {{ 'active' if active_page == 'help' else '' }}"><i class="fas fa-question-circle me-2"></i> Ayuda</a>
            
            <a href="{{ url_for('about') }}" class="sidebar-link {{ 'active' if active_page == 'about' else '' }}"><i class="fas fa-info-circle me-2"></i> Acerca de...</a>
            <a href="{{ url_for('logout') }}" class="sidebar-link text-danger"><i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión</a>
        </div>
    {% endmacro %}

    <nav class="navbar navbar-dark mobile-navbar d-md-none sticky-top">
      <div class="container-fluid">
        <!-- NOMBRE DEL MANTENIMIENTO DINÁMICO (MÓVIL) -->
        <span class="navbar-brand mb-0 h1">{{ maintenance_name }}</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu"><span class="navbar-toggler-icon"></span></button>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start mobile-navbar text-white d-md-none" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header"><h5 class="offcanvas-title">Menú</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
      <div class="offcanvas-body p-0">{{ render_navigation() }}</div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-none d-md-block sidebar-container p-0">{{ render_navigation() }}</nav>
            <main class="col-md-9 ms-sm-auto col-lg-10 content">
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
                {% endwith %}
                <div class="alert alert-secondary py-1 px-3 mb-3 d-flex justify-content-between align-items-center"><small><i class="fas fa-calendar-day"></i> Fecha Sistema: <strong>{{ system_date }}</strong></small></div>
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <!-- Scripts Locales (Bootstrap, jQuery, DataTables) -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>

    <script>
    // Custom Smart Export Config
    function smartExportConfig(type) {
        return {
            extend: type,
            exportOptions: {
                rows: function ( idx, data, node ) {
                    var dt = new $.fn.dataTable.Api(node);
                    var selected = dt.rows( { selected: true } ).indexes();
                    if ( selected.length === 0 ) {
                        return true; 
                    }
                    return selected.indexOf( idx ) !== -1;
                }
            }
        };
    }

    $(document).ready(function() {
        const htmlElement = document.documentElement;

        function updateThemeUI(theme) {
            $('.theme-toggle-btn').each(function() {
                const $icon = $(this).find('i');
                const $text = $(this).find('.theme-text');
                if (theme === 'dark') {
                    $icon.attr('class', 'fas fa-sun me-1');
                    $text.text('Modo Claro');
                } else {
                    $icon.attr('class', 'fas fa-moon me-1');
                    $text.text('Modo Oscuro');
                }
            });
        }

        updateThemeUI(htmlElement.getAttribute('data-bs-theme'));

        $(document).on('click', '.theme-toggle-btn', function() {
            const currentTheme = htmlElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('gmao-theme', newTheme);
            updateThemeUI(newTheme);
        });

        $('.datatable').DataTable({
            language: { url: "{{ url_for('static', filename='js/es-ES.json') }}" },
            dom: 'Bfrtip',
            stateSave: true,
            stateSaveParams: function (settings, data) {
                data.version = "7.10"; 
            },
            stateLoadParams: function (settings, data) {
                if (data.version !== "7.10") {
                    return false; 
                }
            },
            buttons: [
                { 
                    extend: 'collection', 
                    text: 'Exportar', 
                    buttons: [
                        smartExportConfig('copy'),
                        smartExportConfig('excel'),
                        smartExportConfig('pdf'),
                        smartExportConfig('print')
                    ], 
                    className: 'btn-secondary' 
                }
            ],
            select: { style: 'multi', selector: 'td:first-child' },
            columnDefs: [{ orderable: false, className: 'select-checkbox', targets: 0 }],
            pageLength: 25,
            order: [[ 1, 'asc' ]]
        });
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
--- FIN ARCHIVO: templates\base.html ---

--- INICIO ARCHIVO: templates\help.html ---
{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2"><i class="fas fa-question-circle me-2"></i> Ayuda del Sistema</h1>
            <p class="text-muted">Guía rápida sobre las funcionalidades de cada módulo.</p>
        </div>
    </div>

    <div class="accordion shadow-sm" id="accordionHelp">
        
        <!-- RESUMEN -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingResumen">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResumen" aria-expanded="true" aria-controls="collapseResumen">
                    <i class="fas fa-chart-pie me-2"></i> <strong>Resumen Ejecutivo</strong>
                </button>
            </h2>
            <div id="collapseResumen" class="accordion-collapse collapse show" aria-labelledby="headingResumen" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Es la pantalla principal del sistema. Muestra gráficas y estadísticas sobre el estado de las órdenes de trabajo y las incidencias en un periodo de tiempo determinado.
                    <ul>
                        <li>Puedes cambiar las fechas del informe en el panel superior "Configuración del Periodo".</li>
                        <li>Las gráficas son interactivas; pasa el ratón por encima para ver detalles.</li>
                        <li>Puedes imprimir un informe con las gráficas y las tablas entre el periodo seleccionado.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingInv">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInv" aria-expanded="false" aria-controls="collapseInv">
                    <i class="fas fa-boxes me-2"></i> <strong>Inventario</strong>
                </button>
            </h2>
            <div id="collapseInv" class="accordion-collapse collapse" aria-labelledby="headingInv" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Aquí se gestionan todos los activos, máquinas o equipos de la planta.
                    <ul>
                        <li>Puedes crear nuevos equipos asignándoles un "Tipo" (ej: Eléctrico, Mecánico).</li>
                        <li>Es posible adjuntar hasta 5 fotos y 5 PDFs (manuales, planos) a cada equipo.</li>
                        <li>Con el boton Exportar, si seleccionas las filas, la información de puede: copiar al portapapeles, pasar a excel, a pdf o impimir. Si no seleccionas ninguna fila es como si las hubieses seleccionados todas. </li>
                        <strong>Nota importante:</strong> Si borras un equipo, se borrarán también todas sus actividades e historiales asociados.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ACTIVIDADES -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingAct">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAct" aria-expanded="false" aria-controls="collapseAct">
                    <i class="fas fa-clipboard-list me-2"></i> <strong>Actividades (Plan de Mantenimiento)</strong>
                </button>
            </h2>
            <div id="collapseAct" class="accordion-collapse collapse" aria-labelledby="headingAct" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Define el "qué" y el "cuándo" del mantenimiento preventivo.
                    <ul>
                        <li><strong>Periodicidad:</strong> Define cada cuántos días se repite la tarea.</li>
                        <li><strong>Generar OTs:</strong> Si está activo, el sistema creará automáticamente las Órdenes de Trabajo futuras basándose en la fecha de inicio y la periodicidad.</li>
                        <li>Si editas una actividad, el plan futuro se recalculará automáticamente.</li>
                        <li>Con el boton Exportar, si seleccionas las filas, la información de puede: copiar al portapapeles, pasar a excel, a pdf o impimir. 
                        Si no seleccionas ninguna fila es como si las hubieses seleccionados todas. </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ÓRDENES DE TRABAJO -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOT">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOT" aria-expanded="false" aria-controls="collapseOT">
                    <i class="fas fa-tools me-2"></i> <strong>Órdenes de Trabajo (OTs)</strong>
                </button>
            </h2>
            <div id="collapseOT" class="accordion-collapse collapse" aria-labelledby="headingOT" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Es el listado de tareas generadas que deben ejecutarse.
                    <ul>
                        <li><strong>Estados:</strong> Pendiente (Rojo), En curso (Amarillo), Realizada (Verde), Prevista (Gris), Aplazada (Violeta) y Rechazada (Negra).</li>
                        <li>Puedes cambiar el estado de una OT haciendo clic en el botón "Gestionar".</li>
                        <li>El sistema genera OTs automáticamente hasta la "Fecha Prevista" configurada en Ajustes.</li>
                        <li>Con el boton Exportar, si seleccionas las filas, la información de puede: copiar al portapapeles, pasar a excel, a pdf o impimir. 
                        Si no seleccionas ninguna fila es como si las hubieses seleccionados todas. </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CRONOGRAMA -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingCron">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCron" aria-expanded="false" aria-controls="collapseCron">
                    <i class="fas fa-calendar-alt me-2"></i> <strong>Cronogramas y Calendario</strong>
                </button>
            </h2>
            <div id="collapseCron" class="accordion-collapse collapse" aria-labelledby="headingCron" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Dos formas visuales de ver la carga de trabajo:
                    <ul>
                        <li><strong>Cronograma OTs:</strong> Una tabla anual donde las filas son los equipos/actividades y las columnas los meses. Permite ver la distribución anual de un vistazo. Puedes revisar los años pasados y 1 año por delante del actual</li>
                        <li><strong>Calendario:</strong> Vista clásica del mes. Útil para ver la carga de trabajo mensual. Puedes ir los meses siguientes o los pasados.</li>
                        <li>En ambas vistas, puedes hacer clic en una tarea para editar su estado rápidamente.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CORRECTIVOS -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingCorr">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCorr" aria-expanded="false" aria-controls="collapseCorr">
                    <i class="fas fa-exclamation-triangle me-2"></i> <strong>Correctivos</strong>
                </button>
            </h2>
            <div id="collapseCorr" class="accordion-collapse collapse" aria-labelledby="headingCorr" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    Módulo para registrar averías imprevistas o incidencias.
                    <ul>
                        <li>Permite registrar qué equipo falló, cuándo se detectó y cuándo se resolvió.</li>
                        <li>Puedes adjuntar fotos de la avería antes y después de la reparación.</li>
                        <li>Con el boton Exportar, si seleccionas las filas, la información de puede: copiar al portapapeles, pasar a excel, a pdf o impimir. 
                        Si no seleccionas ninguna fila es como si las hubieses seleccionados todas. </li>
                        <li>Útil para calcular el tiempo medio entre fallos (MTBF) en el futuro.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CONFIGURACIÓN -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingConf">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConf" aria-expanded="false" aria-controls="collapseConf">
                    <i class="fas fa-cog me-2"></i> <strong>Configuración Global</strong>
                </button>
            </h2>
            <div id="collapseConf" class="accordion-collapse collapse" aria-labelledby="headingConf" data-bs-parent="#accordionHelp">
                <div class="accordion-body">
                    <strong><u>Zona administrativa</u></strong> (requiere permisos especiales).
                    <ul>
                        <li><strong>Identidad:</strong> Cambia el nombre del mantenimiento que aparece en la cabecera.</li>
                        <li><strong>Fecha del Sistema:</strong> Útil para simular el paso del tiempo o ajustar el "hoy" del programa.</li>
                        <li><strong>Planificación Futura:</strong> Define hasta qué fecha futura quieres que el sistema genere OTs preventivas ("Previstas").</li>
                        <li><strong>Backups:</strong> Descarga y restaura copias de seguridad de la base de datos.</li>
                        <li><strong>Usuarios:</strong> Crea nuevos usuarios y gestiona sus permisos (Inventario, Actividades, Configuración).</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\help.html ---

--- INICIO ARCHIVO: templates\login.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - GMAO Factory</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>body { background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; height: 100vh; } .login-card { max-width: 400px; width: 100%; padding: 20px; }</style>
</head>
<body>
    <div class="card login-card shadow">
        <div class="card-body"><h3 class="text-center mb-4">🏭 GMAO Factory</h3>{% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}{% endif %}{% endwith %}<form action="{{ url_for('login') }}" method="POST"><div class="mb-3"><label class="form-label">Usuario</label><input type="text" class="form-control" name="username" required autofocus></div><div class="mb-3"><label class="form-label">Contraseña</label><input type="password" class="form-control" name="password" required></div><button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button></form><div class="mt-3 text-center text-muted"><small>Acceso restringido</small></div></div>
    </div>
</body>
</html>
--- FIN ARCHIVO: templates\login.html ---

--- INICIO ARCHIVO: templates\viewer.html ---
{% extends "base.html" %}
{% block content %}
<div class="mb-3"><a href="{{ back_url }}" class="btn btn-secondary">&larr; Volver</a><h3>{{ title_prefix }}: {{ item.nombre }}</h3></div>
<div class="row">
    {% if tipo == 'img' %}{% for file in files %}<div class="col-md-6 mb-4"><div class="card"><img src="data:image/png;base64,{{ file.data }}" class="card-img-top"><div class="card-footer text-muted">{{ file.name }}</div></div></div>{% endfor %}
    {% elif tipo == 'pdf' %}{% for file in files %}<div class="col-12 mb-5"><div class="card h-100"><div class="card-header">{{ file.name }}</div><div class="card-body p-0" style="height: 600px;"><embed src="data:application/pdf;base64,{{ file.data }}" type="application/pdf" width="100%" height="100%"></div></div></div>{% endfor %}
    {% endif %}
</div>
{% if not files %}<div class="alert alert-warning">No hay archivos.</div>{% endif %}
{% endblock %}
--- FIN ARCHIVO: templates\viewer.html ---

--- INICIO ARCHIVO: templates\activities\edit.html ---
{% extends "base.html" %}

{% block content %}
<style>
    /* Estilos locales para asegurar el contraste en esta página */
    [data-bs-theme="dark"] .card {
        background-color: #1e2125 !important;
        border-color: #373b3e !important;
    }
    [data-bs-theme="dark"] .card-header {
        background-color: #2b3035 !important;
        color: #f8f9fa !important;
        border-bottom-color: #373b3e !important;
    }
    [data-bs-theme="dark"] .form-label {
        color: #dee2e6 !important;
    }
    [data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
        color: #fff !important;
    }
    [data-bs-theme="dark"] .input-group-text {
        background-color: #343a40 !important;
        border-color: #495057 !important;
        color: #dee2e6 !important;
    }
</style>

<div class="mb-4">
    <h2 class="h3"><i class="fas fa-edit me-2"></i> Editar Actividad</h2>
    <p class="text-muted">Modifica los detalles de la actividad seleccionada.</p>
</div>

<div class="card shadow-sm">
    <div class="card-header fw-bold">
        {{ activity.nombre }}
    </div>
    <div class="card-body">
        <form action="{{ url_for('update_activity', id=activity.id) }}" method="POST" class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">Nombre de la Actividad</label>
                <input type="text" class="form-control" name="nombre" value="{{ activity.nombre }}" required>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold">Equipo Asociado</label>
                <select class="form-select" name="equipo_id" required>
                    {% for eq in equipos %}
                    <option value="{{ eq.id }}" {{ 'selected' if eq.id == activity.equipo_id }}>
                        {{ eq.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold">Periodicidad (días)</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-redo"></i></span>
                    <input type="number" class="form-control" name="periodicidad" value="{{ activity.periodicidad }}" required min="1">
                </div>
            </div>
            
            <div class="col-md-6">
                <label class="form-label fw-bold">Fecha de Inicio Generación</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" class="form-control" name="fecha_inicio" value="{{ activity.fecha_inicio_gen }}" required>
                </div>
            </div>

            <div class="col-md-12">
                <div class="p-3 border rounded bg-light-subtle d-flex align-items-center">
                    <div class="form-check form-switch">
                        <input class="form-check-input" style="width: 3em; height: 1.5em;" type="checkbox" name="generar_ot" value="1" id="switchGenerarOT" 
                               {{ 'checked' if activity.generar_ot else '' }}>
                    </div>
                    <div class="ms-3">
                        <label class="form-check-label fw-bold d-block" for="switchGenerarOT">
                            Generar Órdenes de Trabajo Automáticas
                        </label>
                        <small class="text-muted">
                            Si desactivas esta opción, el sistema <strong>eliminará las OTs futuras (estado "Prevista")</strong> de esta actividad y dejará de crear nuevas.
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <label class="form-label fw-bold">Operaciones a Realizar</label>
                <textarea class="form-control" name="operaciones" rows="4" required placeholder="Tareas de mantenimiento...">{{ activity.operaciones }}</textarea>
            </div>
            
            <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                <a href="{{ url_for('activities') }}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\activities\edit.html ---

--- INICIO ARCHIVO: templates\activities\index.html ---
{% extends "base.html" %}

{% block content %}
<style>
    .form-check-input:checked {
        background-color: #0d6efd !important;
        /* Negro/Gris oscuro */
        border-color: #212529 !important;
    }
</style>




<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Gestión de Actividades</h1>
    <div>
        {% if session.get('perm_actividades') %}
        <button class="btn btn-primary btn-sm me-2" type="button" data-bs-toggle="collapse"
            data-bs-target="#formNuevaActividad">
            <i class="fas fa-plus"></i> Nueva Actividad
        </button>
        {% endif %}
        <a href="{{ url_for('print_all_activities') }}" class="btn btn-secondary btn-sm" target="_blank">
            <i class="fas fa-print"></i> Imprimir Todo
        </a>
    </div>
</div>

<div class="collapse mb-4" id="formNuevaActividad">
    <div class="card card-body bg-light">
        <h5 class="card-title mb-3">Registrar Nueva Actividad</h5>
        <form action="{{ url_for('add_activity') }}" method="POST" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Nombre Actividad</label>
                <input type="text" class="form-control" name="nombre" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Equipo Asociado</label>
                <select class="form-select" name="equipo_id" required>
                    {% for eq in equipos %}
                    <option value="{{ eq.id }}">{{ eq.nombre }} ({{ eq.tipo_nombre }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Periodicidad (días)</label>
                <input type="number" class="form-control" name="periodicidad" required min="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">Inicio Generación</label>
                <input type="date" class="form-control" name="fecha_inicio" required>
            </div>
             <div class="text-muted">
                        Si el periodo en días es divisible entre 30, el programa lo entiende que son meses completos.
                        Por ejemplo: Si pones 30 días, será 1 mes. Si pones 90 días, serán 3 meses.
                        Si pones 360 días, será 1 año (12 meses)
                    </div>
            <div class="col-12 d-flex align-items-end">
                <div class="form-check form-switch">
                    <!-- <input class="form-check-input ms-0 me-2" type="checkbox" name="generar_ot" value="1" id="checkGenOT" checked> -->

                    <input class="form-check-input" style="width: 3em; height: 1.5em;" type="checkbox" name="generar_ot"
                        value="1" id="checkGenOT" checked=true>
                    <label class="form-check-label small fw-bold" for="checkGenOT">Generar OTs. </label>
                    <div class="text-muted">
                        Por defecto, esta activada la generación de Ordenes de Trabajo (OTs). Si desactivas esta opción no se crearán.
                    </div>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label">Operaciones a realizar</label>
                <textarea class="form-control" name="operaciones" rows="2" required></textarea>
            </div>
            <div class="col-12 text-end">
                <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse"
                    data-bs-target="#formNuevaActividad">Cancelar</button>
                <button type="submit" class="btn btn-success">Crear Actividad</button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered datatable" id="tablaActividades">
        <thead class="table-light">
            <tr>
                <th></th>
                <th>Actividad</th>
                <th>Equipo</th>
                <th>Frecuencia</th>
                <th class="text-center">Genera OT</th>
                <th>Inicio</th>
                <th>Operaciones</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for act in actividades %}
            <tr>
                <td></td>
                <td>{{ act.nombre }}</td>
                <td>{{ act.equipo_nombre }}</td>
                <td>Cada {{ act.periodicidad }} días</td>

                <td class="text-center align-middle">
                    {% if act.generar_ot %}
                    <span class="badge bg-success"><i class="fas fa-check"></i> Sí</span>
                    {% else %}
                    <span class="badge bg-secondary"><i class="fas fa-ban"></i> No</span>
                    {% endif %}
                </td>

                <td>{{ act.fecha_inicio_gen }}</td>
                <td><small>{{ act.operaciones }}</small></td>
                <td>
                    <a href="{{ url_for('print_activity_single', id=act.id) }}" class="btn btn-sm btn-secondary mb-1"
                        target="_blank" title="Imprimir PDF">
                        <i class="fas fa-print"></i>
                    </a>
                    {% if session.get('perm_actividades') %}
                    <a href="{{ url_for('edit_activity', id=act.id) }}" class="btn btn-sm btn-warning mb-1">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button type="button" class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal"
                        data-bs-target="#deleteActivityModal{{ act.id }}">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for act in actividades %}
<div class="modal fade" id="deleteActivityModal{{ act.id }}" tabindex="-1"
    aria-labelledby="deleteActivityLabel{{ act.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteActivityLabel{{ act.id }}">Confirmar Borrado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-start">
                <p>¿Estás seguro de que quieres borrar la actividad <strong>{{ act.nombre }}</strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Atención:</strong> Esta acción borrará también
                    todas las <strong>Órdenes de Trabajo</strong> vinculadas a esta actividad. Esta acción no se puede
                    deshacer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('delete_activity', id=act.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Sí, borrar todo</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}
--- FIN ARCHIVO: templates\activities\index.html ---

--- INICIO ARCHIVO: templates\calendar\index.html ---
{% extends 'base.html' %}

{% block content %}
<div class="row mb-3 d-print-none">
    <div class="col-md-8">
        <h2><i class="fas fa-calendar-alt"></i> Calendario de Órdenes de Trabajo</h2>
        <p class="text-muted">Visualización mensual de mantenimientos.</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-secondary" onclick="window.print()">
            <i class="fas fa-print"></i> Imprimir Calendario
        </button>
    </div>
</div>

<!-- Título visible SOLO en impresión -->
<div id="print-title" class="d-none d-print-block text-center mb-4">
    <h2 id="print-month-year" class="text-uppercase"></h2>
</div>

<div class="card shadow">
    <div class="card-body">
        <!-- Leyenda de colores -->
        <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
            <strong>Leyenda:</strong>
            <span class="badge bg-danger">Pendiente</span>
            <span class="badge bg-warning text-dark">En curso</span>
            <span class="badge bg-success">Realizada</span>
            <span class="badge bg-secondary">Prevista</span>
            <span class="badge text-white" style="background-color: #6f42c1;">Aplazada</span>
            <span class="badge text-white" style="background-color: #000000;">Rechazada</span>
        </div>

        <!-- Contenedor del Calendario -->
        <div id='calendar'></div>
    </div>
</div>

<!-- Modal para Editar OT -->
<div class="modal fade" id="editOTModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editOTForm" method="POST" action="">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Orden de Trabajo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="redirect_to" value="calendar">
          <!-- NUEVO: Campo oculto para guardar la fecha actual del calendario -->
          <input type="hidden" name="current_calendar_date" id="currentCalendarDate">
          
          <div class="mb-3">
            <label class="form-label">Orden de Trabajo</label>
            <input type="text" class="form-control" id="otTitle" readonly>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Fecha Programada</label>
            <input type="text" class="form-control" id="otDate" readonly>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Estado</label>
            <select class="form-select" name="estado" id="otStatus">
                <option value="Pendiente">Pendiente</option>
                <option value="En curso">En curso</option>
                <option value="Realizada">Realizada</option>
                <option value="Prevista">Prevista</option>
                <option value="Aplazada">Aplazada</option>
                <option value="Rechazada">Rechazada</option>
            </select>
          </div>
          
          <div class="mb-3">
             <label class="form-label">Fecha Realización</label>
             <input type="date" class="form-control" name="fecha_realizada" id="otFechaRealizada">
          </div>

          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <textarea class="form-control" name="observaciones" id="otObservaciones" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <!-- Enlace para imprimir -->
          <a href="#" id="printOTLink" class="btn btn-outline-secondary" target="_blank">
             <i class="fas fa-print"></i> Imprimir
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Estilos y Scripts de FullCalendar (LOCAL) -->
<script src="{{ url_for('static', filename='js/fullcalendar.min.js') }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var printTitleEl = document.getElementById('print-month-year');
    
    // Elementos del Modal
    var editModal = new bootstrap.Modal(document.getElementById('editOTModal'));
    var modalTitleInput = document.getElementById('otTitle');
    var modalDateInput = document.getElementById('otDate');
    var modalStatusSelect = document.getElementById('otStatus');
    var modalObsInput = document.getElementById('otObservaciones');
    var modalForm = document.getElementById('editOTForm');
    var modalPrintLink = document.getElementById('printOTLink');
    var currentCalendarDateInput = document.getElementById('currentCalendarDate');

    // NUEVO: Detectar si hay una fecha en la URL para inicializar el calendario ahí
    const urlParams = new URLSearchParams(window.location.search);
    const initialDateParam = urlParams.get('date');

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      // NUEVO: Si tenemos fecha en URL, la usamos. Si no, usa la actual por defecto.
      initialDate: initialDateParam ? initialDateParam : undefined,
      locale: 'es', // Idioma español
      firstDay: 1,  // 1 = Lunes
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth'
      },
      buttonText: {
        today: 'Hoy', month: 'Mes', week: 'Semana', day: 'Día', list: 'Lista'
      },
      events: '/api/calendar_events', 
      
      datesSet: function(info) {
        if(printTitleEl) {
            printTitleEl.innerText = info.view.title;
        }
      },

      eventDidMount: function(info) {
        if (info.event.backgroundColor === '#ffc107') {
            info.el.style.color = '#000000';
            var content = info.el.querySelectorAll('.fc-event-main, .fc-event-title, .fc-event-time');
            content.forEach(function(element) {
                element.style.color = '#000000';
            });
        }
      },

      // Manejo del clic para abrir modal
      eventClick: function(info) {
        info.jsEvent.preventDefault(); // Evitar navegar a la URL por defecto

        // Rellenar datos del modal
        modalTitleInput.value = info.event.title;
        
        // Formatear fecha bonita
        var d = info.event.start;
        var datestring = d.getDate() + "/" + (d.getMonth()+1) + "/" + d.getFullYear();
        modalDateInput.value = datestring;

        // Recuperar props extendidas (estado, observaciones)
        var props = info.event.extendedProps;
        if (props) {
            modalStatusSelect.value = props.estado;
            modalObsInput.value = props.observaciones;
        }

        // Configurar acción del formulario para apuntar a la ruta de update correcta
        // Ruta: /work_orders/update/<id>
        modalForm.action = "/work_orders/update/" + info.event.id;
        
        // Configurar enlace de impresión
        modalPrintLink.href = "/work_orders/print/" + info.event.id;

        // Mostrar modal
        editModal.show();
      }
    });
    
    // NUEVO: Antes de enviar el formulario, guardamos la fecha actual del calendario
    modalForm.addEventListener('submit', function() {
        if (calendar) {
            // Guardamos la fecha en formato ISO para recuperarla luego
            currentCalendarDateInput.value = calendar.getDate().toISOString();
        }
    });

    calendar.render();
  });
</script>

<style>
    /* Ajuste para que el calendario tenga una altura decente */
    #calendar {
        max-height: 800px;
    }
    .fc-event {
        cursor: pointer;
        border: none;
        padding: 2px;
    }
    
    /* Estilos específicos para impresión */
    @media print {
        @page {
            size: landscape;
            margin: 5mm;
        }
        html, body {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            background: white !important;
        }
        .content, .container-fluid, .row, main, .card, .card-body {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            box-shadow: none !important;
            display: block !important;
        }
        .d-print-block {
            display: block !important;
        }
        #calendar {
            width: 100% !important;
            max-width: none !important;
            height: auto !important;
            overflow: visible !important;
        }
        .fc-scrollgrid, .fc-col-header, .fc-daygrid-body, .fc-daygrid-body table, .fc table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        .fc-view-harness {
            width: 100% !important;
            height: auto !important;
        }
        .fc-scroller {
            overflow: visible !important;
            height: auto !important;
        }
        .fc-scroller-liquid-absolute {
            position: static !important;
        }
        .fc {
            font-size: 10pt !important;
        }
        .fc-toolbar {
            display: none !important;
        }
        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .sidebar-container, .mobile-navbar, .alert, .btn-print-hide, footer, .d-print-none {
            display: none !important;
        }
    }
</style>
{% endblock %}
--- FIN ARCHIVO: templates\calendar\index.html ---

--- INICIO ARCHIVO: templates\correctivos\edit.html ---
{% extends "base.html" %}

{% block content %}
<style>
    /* Estilos locales para asegurar el contraste en esta página sin tocar base.html */
    [data-bs-theme="dark"] .card {
        background-color: #1e2125 !important;
        border-color: #373b3e !important;
    }
    [data-bs-theme="dark"] .card-header {
        background-color: #2b3035 !important;
        color: #f8f9fa !important;
        border-bottom-color: #373b3e !important;
    }
    [data-bs-theme="dark"] .list-group-item {
        background-color: #2b3035 !important;
        border-color: #373b3e !important;
        color: #dee2e6 !important;
    }
    [data-bs-theme="dark"] .form-label {
        color: #dee2e6 !important;
    }
    [data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
        color: #fff !important;
    }
    [data-bs-theme="dark"] .input-group-text {
        background-color: #343a40 !important;
        border-color: #495057 !important;
        color: #dee2e6 !important;
    }
</style>

<div class="mb-4">
    <h2 class="h3"><i class="fas fa-tools me-2"></i> Editar Incidencia</h2>
    <p class="text-muted">Actualiza los detalles del mantenimiento correctivo o avería.</p>
</div>

<div class="card shadow-sm">
    <div class="card-header fw-bold">
        {{ item.nombre }}
    </div>
    <div class="card-body">
        <form action="{{ url_for('update_correctivo', id=item.id) }}" method="POST" enctype="multipart/form-data">
            <div class="row">
                <!-- Columna Izquierda -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre de la Incidencia</label>
                        <input type="text" class="form-control" name="nombre" value="{{ item.nombre }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Equipo Afectado</label>
                        <select class="form-select" name="equipo_id" required>
                            {% for eq in equipos %}
                            <option value="{{ eq.id }}" {{ 'selected' if eq.id == item.equipo_id }}>
                                {{ eq.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Comentario / Descripción</label>
                        <textarea class="form-control" name="comentario" rows="3">{{ item.comentario }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Solución Aplicada</label>
                        <textarea class="form-control" name="solucion" rows="3">{{ item.solucion }}</textarea>
                    </div>
                </div>

                <!-- Columna Derecha -->
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fecha Detectada</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="date" class="form-control" name="fecha_detectada" value="{{ item.fecha_detectada }}" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Fecha Resolución</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-check-circle"></i></span>
                                <input type="date" class="form-control" name="fecha_resolucion" value="{{ item.fecha_resolucion or '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado Actual</label>
                        <select class="form-select" name="estado">
                            <option value="Detectada" {{ 'selected' if item.estado == 'Detectada' }}>Detectada</option>
                            <option value="En curso" {{ 'selected' if item.estado == 'En curso' }}>En curso</option>
                            <option value="Resuelta" {{ 'selected' if item.estado == 'Resuelta' }}>Resuelta</option>
                        </select>
                    </div>

                    <!-- Gestión de Imágenes -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center py-2">
                            <span class="small fw-bold"><i class="fas fa-images me-1"></i> Imágenes ({{ imgs|length }}/5)</span>
                        </div>
                        <div class="card-body p-2">
                            {% if imgs %}
                            <div class="list-group mb-2">
                                {% for img in imgs %}
                                <div class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                    <small class="text-truncate" style="max-width: 180px;">{{ img.name }}</small> 
                                    <input class="form-check-input" type="checkbox" name="delete_images" value="{{ loop.index0 }}">
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if imgs|length < 5 %}
                            <input type="file" class="form-control form-control-sm" name="images" multiple accept="image/*">
                            {% endif %}
                        </div>
                    </div>

                    <!-- Gestión de PDFs -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center py-2">
                            <span class="small fw-bold"><i class="fas fa-file-pdf me-1"></i> Documentos ({{ pdfs|length }}/5)</span>
                        </div>
                        <div class="card-body p-2">
                            {% if pdfs %}
                            <div class="list-group mb-2">
                                {% for pdf in pdfs %}
                                <div class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                    <small class="text-truncate" style="max-width: 180px;">{{ pdf.name }}</small> 
                                    <input class="form-check-input" type="checkbox" name="delete_pdfs" value="{{ loop.index0 }}">
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if pdfs|length < 5 %}
                            <input type="file" class="form-control form-control-sm" name="pdfs" multiple accept="application/pdf">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-3 border-top d-flex justify-content-end gap-2">
                <a href="{{ url_for('correctivos') }}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\correctivos\edit.html ---

--- INICIO ARCHIVO: templates\correctivos\index.html ---
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4"><h1 class="h2">Correctivos e Incidencias</h1><div><button class="btn btn-primary btn-sm me-2" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevoCorrectivo"><i class="fas fa-plus"></i> Nueva Incidencia</button><a href="{{ url_for('print_all_correctivos') }}" class="btn btn-secondary btn-sm" target="_blank"><i class="fas fa-print"></i> Imprimir Todo</a></div></div><div class="collapse mb-4" id="formNuevoCorrectivo"><div class="card card-body bg-light"><h5 class="card-title mb-3">Registrar Nueva Incidencia</h5><form action="{{ url_for('add_correctivo') }}" method="POST" enctype="multipart/form-data" class="row g-3"><div class="col-md-6"><label class="form-label">Nombre del Correctivo</label><input type="text" class="form-control" name="nombre" required></div><div class="col-md-6"><label class="form-label">Equipo Afectado</label><select class="form-select" name="equipo_id" required>{% for eq in equipos %}<option value="{{ eq.id }}">{{ eq.nombre }} ({{ eq.tipo_nombre }})</option>{% endfor %}</select></div><div class="col-12"><label class="form-label">Comentario</label><textarea class="form-control" name="comentario" rows="2"></textarea></div><div class="col-md-3"><label class="form-label">Fecha Detectada</label><input type="date" class="form-control" name="fecha_detectada" value="{{ system_date }}" required></div><div class="col-md-3"><label class="form-label">Estado Inicial</label><select class="form-select" name="estado"><option value="Detectada">Detectada</option><option value="En curso">En curso</option><option value="Resuelta">Resuelta</option></select></div><div class="col-md-3"><label class="form-label">Imágenes</label><input type="file" class="form-control" name="images" multiple accept="image/*"></div><div class="col-md-3"><label class="form-label">PDFs</label><input type="file" class="form-control" name="pdfs" multiple accept="application/pdf"></div><div class="col-12 text-end"><button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#formNuevoCorrectivo">Cancelar</button><button type="submit" class="btn btn-danger">Guardar Incidencia</button></div></form></div></div>

<!-- Filter Row -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="min-corr" class="form-label">Fecha Desde:</label>
                <input type="date" id="min-corr" name="min-corr" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="max-corr" class="form-label">Fecha Hasta:</label>
                <input type="date" id="max-corr" name="max-corr" class="form-control">
            </div>
        </div>
    </div>
</div>

<div class="table-responsive"><table class="table table-hover align-middle datatable" id="tablaCorrectivos"><thead class="table-dark"><tr><th></th><th>ID</th><th>Incidencia</th><th>Equipo</th><th>Estado</th><th>Detectada</th><th>Resolución</th><th>Archivos</th><th>Acciones</th></tr></thead><tbody>{% for c in correctivos %}<tr><td></td><td>{{ c.id }}</td><td>{{ c.nombre }}</td><td>{{ c.equipo_nombre }}</td><td>{% if c.estado == 'Detectada' %}<span class="badge corr-detectada">Detectada</span>{% elif c.estado == 'En curso' %}<span class="badge corr-en-curso">En curso</span>{% elif c.estado == 'Resuelta' %}<span class="badge corr-resuelta">Resuelta</span>{% endif %}</td><td>{{ c.fecha_detectada }}</td><td>{{ c.fecha_resolucion or '-' }}</td><td>{% set imgs = c.images|json_load %}{% set pdfs = c.pdfs|json_load %}{% if imgs or pdfs %}<span class="badge bg-secondary">{{ imgs|length }} <i class="fas fa-image"></i></span> <span class="badge bg-secondary">{{ pdfs|length }} <i class="fas fa-file-pdf"></i></span>{% else %}-{% endif %}</td><td><a href="{{ url_for('print_correctivo', id=c.id) }}" class="btn btn-sm btn-secondary" target="_blank"><i class="fas fa-print"></i></a> <a href="{{ url_for('edit_correctivo', id=c.id) }}" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></a> <form action="{{ url_for('delete_correctivo', id=c.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Borrar?');"><button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></form></td></tr>{% endfor %}</tbody></table></div>
<script>function verGaleria(source, tipo, id) {window.location.href = "/view_files/" + source + "/" + tipo + "/" + id;}</script>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Restaurar filtros de fecha desde localStorage
    var savedMin = localStorage.getItem('corr_min_date');
    var savedMax = localStorage.getItem('corr_max_date');
    
    if (savedMin) $('#min-corr').val(savedMin);
    if (savedMax) $('#max-corr').val(savedMax);

    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            if ( settings.nTable.id !== 'tablaCorrectivos' ) {
                return true;
            }
            
            var min = $('#min-corr').val();
            var max = $('#max-corr').val();
            var date = data[5]; // Index 5 is Fecha Detectada (YYYY-MM-DD)

            if (
                ( min === "" || min === null ) && ( max === "" || max === null ) ||
                ( min === "" || min === null ) && date <= max ||
                ( min <= date ) && ( max === "" || max === null ) ||
                ( min <= date && date <= max )
            ) {
                return true;
            }
            return false;
        }
    );
 
    $('#min-corr, #max-corr').on('change', function () {
        // Guardar en localStorage
        localStorage.setItem('corr_min_date', $('#min-corr').val());
        localStorage.setItem('corr_max_date', $('#max-corr').val());
        $('#tablaCorrectivos').DataTable().draw();
    });

    if (savedMin || savedMax) {
        setTimeout(function(){
            $('#tablaCorrectivos').DataTable().draw();
        }, 100);
    }
});
</script>
{% endblock %}
--- FIN ARCHIVO: templates\correctivos\index.html ---

--- INICIO ARCHIVO: templates\inventory\edit.html ---
{% extends "base.html" %}
{% block content %}
<h2>Editar Equipo: {{ item.nombre }}</h2><form action="{{ url_for('update_inventory', id=item.id) }}" method="POST" enctype="multipart/form-data" class="mt-4"><div class="row"><div class="col-md-7"><div class="mb-3"><label class="form-label">Nombre</label><input type="text" class="form-control" name="nombre" value="{{ item.nombre }}" required></div><div class="mb-3"><label class="form-label">Tipo</label><select class="form-select" name="tipo_id" required>{% for t in tipos %}<option value="{{ t.id }}" {{ 'selected' if t.id == item.tipo_id }}>{{ t.nombre }}</option>{% endfor %}</select></div><div class="mb-3"><label class="form-label">Descripción</label><textarea class="form-control" name="descripcion" rows="3">{{ item.descripcion }}</textarea></div></div><div class="col-md-5"><div class="card mb-3"><div class="card-header d-flex justify-content-between align-items-center"><span>Imágenes ({{ imgs|length }}/5)</span><small class="text-muted">Selecciona para borrar</small></div><div class="card-body">{% if imgs %}<div class="list-group mb-3">{% for img in imgs %}<div class="list-group-item d-flex justify-content-between align-items-center"><div class="text-truncate" style="max-width: 200px;">{{ img.name }}</div><div class="form-check"><input class="form-check-input" type="checkbox" name="delete_images" value="{{ loop.index0 }}"></div></div>{% endfor %}</div>{% endif %}{% if imgs|length < 5 %}<input type="file" class="form-control form-control-sm" name="images" multiple accept="image/*">{% endif %}</div></div><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>PDFs ({{ pdfs|length }}/5)</span><small>Selecciona para borrar</small></div><div class="card-body">{% if pdfs %}<div class="list-group mb-3">{% for pdf in pdfs %}<div class="list-group-item d-flex justify-content-between align-items-center"><div class="text-truncate" style="max-width: 200px;">{{ pdf.name }}</div><div class="form-check"><input class="form-check-input" type="checkbox" name="delete_pdfs" value="{{ loop.index0 }}"></div></div>{% endfor %}</div>{% endif %}{% if pdfs|length < 5 %}<input type="file" class="form-control form-control-sm" name="pdfs" multiple accept="application/pdf">{% endif %}</div></div></div></div><hr><div class="d-flex justify-content-end gap-2"><a href="{{ url_for('inventory') }}" class="btn btn-secondary">Cancelar</a><button type="submit" class="btn btn-primary">Guardar Cambios</button></div></form>
{% endblock %}
--- FIN ARCHIVO: templates\inventory\edit.html ---

--- INICIO ARCHIVO: templates\inventory\index.html ---
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Inventario de Equipos</h1>
    <div>
        {% if session.get('perm_inventario') %}<button class="btn btn-primary btn-sm" data-bs-toggle="modal"
            data-bs-target="#addEquipModal">+ Nuevo Equipo</button>{% endif %}
        <a href="{{ url_for('print_all_inventory') }}" class="btn btn-secondary btn-sm me-2" target="_blank"><i
                class="fas fa-print"></i> Imprimir Todo</a>
    </div>
</div>
<div class="table-responsive">
    <table class="table table-striped table-hover datatable" id="tablaInventario">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>ID</th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Archivos</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>{% for item in items %}<tr>
                <td></td>
                <td>{{ item.id }}</td>
                <td>{{ item.nombre }}</td>
                <td>{{ item.tipo_nombre }}</td>
                <td>{{ item.descripcion }}</td>
                <td>{% set imgs = item.images|json_load %}{% if imgs %}<button class="btn btn-info btn-sm btn-xs"
                        onclick="verGaleria('inventory', 'img', '{{ item.id }}')"><i class="fas fa-images"></i> {{
                        imgs|length }}</button>{% endif %}{% set pdfs = item.pdfs|json_load %}{% if pdfs %}<button
                        class="btn btn-danger btn-sm btn-xs"
                        onclick="verGaleria('inventory', 'pdf', '{{ item.id }}')"><i class="fas fa-file-pdf"></i> {{
                        pdfs|length }}</button>{% endif %}</td>
                <td><a href="{{ url_for('print_inventory', id=item.id) }}" class="btn btn-sm btn-secondary mb-1"
                        target="_blank" title="Imprimir PDF"><i class="fas fa-print"></i></a> {% if
                    session.get('perm_inventario') %}<a href="{{ url_for('edit_inventory', id=item.id) }}"
                        class="btn btn-sm btn-warning mb-1" title="Editar"><i class="fas fa-edit"></i></a> <button
                        type="button" class="btn btn-sm btn-danger mb-1" data-bs-toggle="modal"
                        data-bs-target="#deleteInventoryModal{{ item.id }}" title="Borrar"><i
                            class="fas fa-trash"></i></button></td>
            </tr>{% endif %}{% endfor %}</tbody>
    </table>
</div>

{% for item in items %}
<div class="modal fade" id="deleteInventoryModal{{ item.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Borrado</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-start">
                <p>¿Estás seguro de que quieres borrar el equipo <strong>{{ item.nombre }}</strong>?</p>
                <div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Atención:</strong>
                    Esta acción borrará permanentemente todos sus datos asociados.</div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('delete_inventory', id=item.id) }}" method="POST"><button type="submit"
                        class="btn btn-danger">Sí, borrar todo</button></form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<div class="modal fade" id="addEquipModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('add_inventory') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Añadir Equipo</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Nombre</label><input type="text" class="form-control"
                            name="nombre" required></div>
                    <div class="mb-3"><label class="form-label">Tipo</label><select class="form-select" name="tipo_id"
                            required>{% for t in tipos %}<option value="{{ t.id }}">{{ t.nombre }}</option>{% endfor
                            %}</select></div>
                    <div class="mb-3"><label class="form-label">Descripción</label><textarea class="form-control"
                            name="descripcion" rows="3"></textarea></div>
                    <div class="mb-3"><label class="form-label">Imágenes (Máx 5)</label><input type="file"
                            class="form-control" name="images" multiple accept="image/*"></div>
                    <div class="mb-3"><label class="form-label">PDFs (Máx 5)</label><input type="file"
                            class="form-control" name="pdfs" multiple accept="application/pdf"></div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-primary">Guardar</button></div>
            </form>
        </div>
    </div>
</div>
<script>function verGaleria(source, tipo, id) { window.location.href = "/view_files/" + source + "/" + tipo + "/" + id; }</script>
{% endblock %}
--- FIN ARCHIVO: templates\inventory\index.html ---

--- INICIO ARCHIVO: templates\print\activity.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Actividad</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}}</style></head><body onload="window.print()"><div class="container"><h1>Actividad: {{ activity.nombre }}</h1><p>Equipo: {{ activity.equipo_nombre }}</p><p>Periodicidad: {{ activity.periodicidad }}</p><p>Operaciones: {{ activity.operaciones }}</p></div></body></html>
--- FIN ARCHIVO: templates\print\activity.html ---

--- INICIO ARCHIVO: templates\print\all_activities.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Actividades</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} table{width:100%;border:1px solid #ddd;} th,td{border:1px solid #ddd;padding:5px;}</style></head><body onload="window.print()"><div class="container"><h2>Listado Actividades</h2><table><thead><tr><th>Actividad</th><th>Equipo</th><th>Freq</th><th>Ops</th></tr></thead><tbody>{% for a in activities %}<tr><td>{{ a.nombre }}</td><td>{{ a.equipo_nombre }}</td><td>{{ a.periodicidad }}</td><td>{{ a.operaciones }}</td></tr>{% endfor %}</tbody></table></div></body></html>
--- FIN ARCHIVO: templates\print\all_activities.html ---

--- INICIO ARCHIVO: templates\print\all_correctivos.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Listado Incidencias</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} table{width:100%;border:1px solid #ddd;} th,td{border:1px solid #ddd;padding:5px;}</style></head><body onload="window.print()"><div class="container"><h2>Listado Incidencias</h2><table><thead><tr><th>ID</th><th>Nombre</th><th>Equipo</th><th>Estado</th><th>Fecha</th></tr></thead><tbody>{% for c in items %}<tr><td>{{ c.id }}</td><td>{{ c.nombre }}</td><td>{{ c.equipo_nombre }}</td><td>{{ c.estado }}</td><td>{{ c.fecha_detectada }}</td></tr>{% endfor %}</tbody></table></div></body></html>
--- FIN ARCHIVO: templates\print\all_correctivos.html ---

--- INICIO ARCHIVO: templates\print\all_inventory.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Listado</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ddd;padding:8px;}</style></head><body onload="window.print()"><div class="container"><h2>Listado Inventario</h2><table class="table"><thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Desc</th></tr></thead><tbody>{% for i in items %}<tr><td>{{ i.id }}</td><td>{{ i.nombre }}</td><td>{{ i.tipo_nombre }}</td><td>{{ i.descripcion }}</td></tr>{% endfor %}</tbody></table></div></body></html>
--- FIN ARCHIVO: templates\print\all_inventory.html ---

--- INICIO ARCHIVO: templates\print\all_ots.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Listado OTs</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} table{width:100%;border:1px solid #ddd;} th,td{border:1px solid #ddd;padding:5px;}</style></head><body onload="window.print()"><div class="container"><h2>Listado Órdenes de Trabajo</h2><table><thead><tr><th>ID</th><th>Nombre</th><th>Equipo</th><th>Fecha</th><th>Estado</th></tr></thead><tbody>{% for ot in ots %}<tr><td>{{ ot.id }}</td><td>{{ ot.nombre }}</td><td>{{ ot.equipo_nombre }}</td><td>{{ ot.fecha_generacion }}</td><td>{{ ot.estado }}</td></tr>{% endfor %}</tbody></table></div></body></html>
--- FIN ARCHIVO: templates\print\all_ots.html ---

--- INICIO ARCHIVO: templates\print\correctivo.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Incidencia</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} img{max-width:100%;}</style></head><body onload="window.print()"><div class="container"><h1>Incidencia: {{ item.nombre }}</h1><p><strong>Estado:</strong> {{ item.estado }}</p><p><strong>Equipo:</strong> {{ item.equipo_nombre }}</p><p><strong>Detectada:</strong> {{ item.fecha_detectada }}</p><p><strong>Comentario:</strong> {{ item.comentario }}</p><p><strong>Solución:</strong> {{ item.solucion }}</p><h3>Fotos</h3><div class="row">{% for img in imgs %}<div class="col-6"><img src="data:image/png;base64,{{ img.data }}"><br>{{ img.name }}</div>{% endfor %}</div><h3>Documentos PDF Adjuntos</h3><ul class="list-group">{% for pdf in pdfs %}<li class="list-group-item d-flex align-items-center"><span style="font-size: 1.5em; color: #dc3545; margin-right: 10px;">📄</span><div><strong>{{ pdf.name }}</strong><br><small class="text-muted">El contenido del PDF se encuentra almacenado digitalmente.</small></div></li>{% else %}<li class="list-group-item">No hay documentos PDF adjuntos.</li>{% endfor %}</ul></div></body></html>
--- FIN ARCHIVO: templates\print\correctivo.html ---

--- INICIO ARCHIVO: templates\print\cronograma.html ---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cronograma de Mantenimiento {{ year }}</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none; }
            @page { size: landscape; margin: 1cm; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .badge-status, .badge-legend { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
        }
        body { padding: 20px; font-family: sans-serif; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 4px; text-align: center; vertical-align: middle; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .text-start { text-align: left; }
        .badge-status {
            font-size: 0.75em;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            margin: 1px;
            color: #fff;
            border: 1px solid #ccc;
        }
        .status-realizada { background-color: #198754 !important; color: white !important; border-color: #198754; }
        .status-en-curso { background-color: #ffc107 !important; color: #212529 !important; border-color: #ffc107; }
        .status-rechazada { background-color: #000000 !important; color: white !important; border-color: #000000; }
        .status-pendiente { background-color: #dc3545 !important; color: white !important; border-color: #dc3545; }
        .status-prevista { background-color: #6c757d !important; color: white !important; border-color: #6c757d; }
        .status-aplazada { background-color: #6f42c1 !important; color: white !important; border-color: #6f42c1; }
        
        .badge-legend {
            display: inline-block;
            padding: 3px 6px;
            font-size: 0.8em;
            font-weight: bold;
            border-radius: 4px;
            margin-right: 5px;
            border: 1px solid #999;
            color: white;
        }
    </style>
</head>
<body onload="window.print()">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Cronograma de Mantenimiento - Año {{ year }}</h2>
            <button class="btn btn-secondary no-print" onclick="window.close()">Cerrar</button>
        </div>

        <table class="table table-bordered table-sm">
            <thead>
                <tr>
                    <th style="width: 20%;">Actividad / Equipo</th>
                    {% for m in meses %}
                    <th>{{ m }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td class="text-start bg-light">
                        <strong>{{ row.actividad }}</strong><br>
                        <span class="text-muted">{{ row.equipo }}</span>
                    </td>
                    {% for month_idx in range(1, 13) %}
                    <td style="vertical-align: top;">
                        {% if month_idx in row.ots %}
                            {% for ot in row.ots[month_idx] %}<div class="badge-status {% if ot.estado == 'Realizada' %}status-realizada{% elif ot.estado == 'En curso' %}status-en-curso{% elif ot.estado == 'Pendiente' %}status-pendiente{% elif ot.estado == 'Prevista' %}status-prevista{% elif ot.estado == 'Aplazada' %}status-aplazada{% else %}status-rechazada{% endif %}" title="{{ ot.nombre }} ({{ ot.fecha }})" data-bs-toggle="modal" data-bs-target="#cronModalOT{{ ot.id }}">{{ ot.day_day }}</div><div class="modal fade text-start" id="cronModalOT{{ ot.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form action="{{ url_for('update_ot', id=ot.id) }}" method="POST"><div class="modal-header"><h5 class="modal-title">{{ ot.nombre }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" name="redirect_to" value="cronograma"><div class="alert alert-secondary"><strong>Operaciones:</strong><br>{{ ot.operaciones }}</div><div class="mb-3"><label class="form-label">Estado</label><select class="form-select" name="estado"><option value="En curso" {{ 'selected' if ot.estado == 'En curso' }}>En curso</option><option value="Pendiente" {{ 'selected' if ot.estado == 'Pendiente' }}>Pendiente</option><option value="Prevista" {{ 'selected' if ot.estado == 'Prevista' }}>Prevista</option><option value="Realizada" {{ 'selected' if ot.estado == 'Realizada' }}>Realizada</option><option value="Aplazada" {{ 'selected' if ot.estado == 'Aplazada' }}>Aplazada</option><option value="Rechazada" {{ 'selected' if ot.estado == 'Rechazada' }}>Rechazada</option></select></div><div class="mb-3"><label class="form-label">Observaciones</label><textarea class="form-control" name="observaciones">{{ ot.observaciones or '' }}</textarea></div><div class="mb-3"><label class="form-label">Fecha Realización</label><input type="date" class="form-control" name="fecha_realizada" value="{{ ot.fecha_realizada or '' }}"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Actualizar OT</button></div></form></div></div></div>{% endfor %}{% endif %}</td>{% endfor %}</tr>{% endfor %}</tbody></table></div><div class="mt-3"><small>Leyenda: <span class="badge status-realizada">Realizada</span> <span class="badge status-en-curso">En Curso</span> <span class="badge status-pendiente">Pendiente</span> <span class="badge status-prevista">Prevista</span> <span class="badge status-aplazada">Aplazada</span> <span class="badge status-rechazada">Rechazada</span>. El número indica el día del mes. Haz click para editar.</small></div>
</body>
</html>
--- FIN ARCHIVO: templates\print\cronograma.html ---

--- INICIO ARCHIVO: templates\print\inventory.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Reporte</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}} img {max-width:100%;}</style></head><body onload="window.print()"><div class="container"><h1>Ficha Técnica</h1><div class="card mb-3"><div class="card-body"><strong>Nombre:</strong> {{ item.nombre }}<br><strong>Tipo:</strong> {{ item.tipo_nombre }}<br><strong>Desc:</strong> {{ item.descripcion }}</div></div><h3>Imágenes</h3><div class="row">{% for img in imgs %}<div class="col-6 mb-3"><img src="data:image/png;base64,{{ img.data }}"><br><small>{{ img.name }}</small></div>{% endfor %}</div><h3>PDFs</h3><ul>{% for pdf in pdfs %}<li>{{ pdf.name }}</li>{% endfor %}</ul></div></body></html>
--- FIN ARCHIVO: templates\print\inventory.html ---

--- INICIO ARCHIVO: templates\print\ot.html ---
<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>OT</title><link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet"><style>@media print {.no-print {display:none;}}</style></head><body onload="window.print()"><div class="container"><h1>Orden de Trabajo #{{ ot.id }}</h1><h3>{{ ot.nombre }}</h3><p><strong>Estado:</strong> {{ ot.estado }}</p><p><strong>Equipo:</strong> {{ ot.equipo_nombre }}</p><p><strong>Fecha Gen:</strong> {{ ot.fecha_generacion }}</p><hr><h5>Operaciones</h5><p>{{ ot.operaciones }}</p><h5>Observaciones</h5><p>{{ ot.observaciones }}</p></div></body></html>
--- FIN ARCHIVO: templates\print\ot.html ---

--- INICIO ARCHIVO: templates\resumen\index.html ---
{% extends "base.html" %}

{% block content %}
<!-- Chart.js Local -->
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Resumen Ejecutivo</h1>
    <span class="text-muted">Estadísticas del periodo seleccionado</span>
</div>

<!-- Tarjeta de configuración: se eliminan bg-primary y bg-light para usar el motor de temas de base.html -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Configuración del Periodo</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('resumen.update_dates') }}" method="POST" class="row align-items-end g-3">
            <div class="col-md-5">
                <label class="form-label">Fecha Inicio Resumen</label>
                <input type="date" class="form-control" name="fecha_inicio" value="{{ fecha_inicio }}" required>
            </div>
            <div class="col-md-5">
                <label class="form-label">Fecha Fin Resumen</label>
                <input type="date" class="form-control" name="fecha_fin" value="{{ fecha_fin }}" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold text-center">Distribución de Órdenes de Trabajo</div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="chartOTs"></canvas>
                </div>
                <div class="mt-3 text-center small text-muted">Total OTs en el periodo: {{ total_ots }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100 shadow-sm">
            <div class="card-header fw-bold text-center">Distribución de Incidencias (Correctivos)</div>
            <div class="card-body">
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="chartCorrectivos"></canvas>
                </div>
                 <div class="mt-3 text-center small text-muted">Total Incidencias en el periodo: {{ total_corr }}</div>
            </div>
        </div>
    </div>
</div>

<hr class="my-4">


<div class="text-center mb-5">
    <button onclick="window.print()" class="btn btn-lg btn-success">
        <i class="fas fa-print me-2"></i> Imprimir Informe Completo
    </button>
</div>


<!-- Tablas de datos -->
<h3 class="mb-3">Órdenes de Trabajo del Periodo</h3>
<div class="table-responsive mb-4">
    <table class="table table-striped table-hover datatable" id="tablaResumenOTs">
        <thead>
            <tr>
                <th></th>
                <th>ID</th>
                <th>Nombre</th>
                <th>Equipo</th>
                <th>Fecha Gen.</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for ot in ots %}
            <tr>
                <td></td>
                <td>{{ ot.id }}</td>
                <td>{{ ot.nombre }}</td>
                <td>{{ ot.equipo_nombre }}</td>
                <td>{{ ot.fecha_generacion }}</td>
                <td>
                    {% if ot.estado == 'Realizada' %}<span class="badge status-realizada">Realizada</span>
                    {% elif ot.estado == 'En curso' %}<span class="badge status-en-curso">En curso</span>
                    {% elif ot.estado == 'Pendiente' %}<span class="badge status-pendiente">Pendiente</span>
                    {% elif ot.estado == 'Prevista' %}<span class="badge status-prevista">Prevista</span>
                    {% elif ot.estado == 'Aplazada' %}<span class="badge status-aplazada">Aplazada</span>
                    {% else %}<span class="badge bg-dark">Rechazada</span>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h3 class="mb-3">Incidencias del Periodo</h3>
<div class="table-responsive mb-5">
    <table class="table table-striped table-hover datatable" id="tablaResumenCorrectivos">
        <thead>
            <tr>
                <th></th>
                <th>ID</th>
                <th>Incidencia</th>
                <th>Equipo</th>
                <th>Fecha Detectada</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for c in correctivos %}
            <tr>
                <td></td>
                <td>{{ c.id }}</td>
                <td>{{ c.nombre }}</td>
                <td>{{ c.equipo_nombre }}</td>
                <td>{{ c.fecha_detectada }}</td>
                <td>
                    {% if c.estado == 'Detectada' %}<span class="badge corr-detectada">Detectada</span>
                    {% elif c.estado == 'En curso' %}<span class="badge corr-en-curso">En curso</span>
                    {% elif c.estado == 'Resuelta' %}<span class="badge corr-resuelta">Resuelta</span>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>



<script>
    const ctxOT = document.getElementById('chartOTs').getContext('2d');
    new Chart(ctxOT, {
        type: 'doughnut',
        data: {
            labels: {{ labels_ot | safe }},
            datasets: [{
                data: {{ values_ot | safe }},
                backgroundColor: ['#198754', '#ffc107', '#dc3545', '#6c757d', '#6f42c1', '#000000'],
                borderWidth: 1
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#dee2e6' : '#212529'
                    }
                } 
            } 
        }
    });

    const ctxCorr = document.getElementById('chartCorrectivos').getContext('2d');
    new Chart(ctxCorr, {
        type: 'pie',
        data: {
            labels: {{ labels_corr | safe }},
            datasets: [{
                data: {{ values_corr | safe }},
                backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                borderWidth: 1
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#dee2e6' : '#212529'
                    }
                } 
            } 
        }
    });
</script>
{% endblock %}
--- FIN ARCHIVO: templates\resumen\index.html ---

--- INICIO ARCHIVO: templates\settings\edit_type.html ---
{% extends "base.html" %}
{% block content %}
<h2>Editar Tipo</h2><form action="{{ url_for('update_type', id=tipo.id) }}" method="POST"><div class="mb-3"><input type="text" class="form-control" name="nombre" value="{{ tipo.nombre }}" required></div><div class="d-flex justify-content-end gap-2"><a href="{{ url_for('general_settings') }}" class="btn btn-secondary">Cancelar</a><button type="submit" class="btn btn-primary">Actualizar</button></div></form>
{% endblock %}
--- FIN ARCHIVO: templates\settings\edit_type.html ---

--- INICIO ARCHIVO: templates\settings\index.html ---
{% extends "base.html" %}
{% block content %}
<h1 class="h2 mb-4">Configuración Global</h1>

<!-- NUEVO PANEL: IDENTIDAD DEL SITIO (Encima de todo) -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-id-card me-2"></i> Identidad del Sitio</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('update_maintenance_name') }}" method="POST" class="row align-items-end">
                    <div class="col-md-10">
                        <label class="form-label">Nombre del Mantenimiento</label>
                        <input type="text" class="form-control form-control-lg" name="nombre_mantenimiento" value="{{ maintenance_name }}" placeholder="Ej: GMAO Planta Principal" required>
                        <div class="form-text">Este nombre aparecerá en la barra lateral y en el menú superior.</div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 btn-lg">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Fecha del Sistema</h5>
            </div>
            <div class="card-body">
                <p>Define la fecha con la que opera el sistema para simulaciones o ajustes temporales.</p>
                <form action="{{ url_for('update_system_date') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Fecha Actual del Sistema</label>
                        <input type="date" class="form-control" name="fecha_sistema" value="{{ system_date }}" required>
                        <div class="form-text">Todas las operaciones automáticas usarán esta fecha.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Actualizar Fecha</button>
                </form>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i> Planificación Futura</h5>
            </div>
            <div class="card-body">
                <p>Generar órdenes de trabajo "Previstas" (Grises) desde mañana hasta una fecha futura.</p>
                <form action="{{ url_for('update_planned_date') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Fecha Prevista (Límite)</label>
                        <input type="date" class="form-control" name="fecha_prevista" value="{{ planned_date or '' }}" required>
                        <div class="form-text">Debe ser posterior a la fecha del sistema.</div>
                    </div>
                    <button type="submit" class="btn btn-success">Actualizar y Generar</button>
                </form>
            </div>
        </div>
        <!-- BLOQUE ACTUALIZADO: COPIA DE SEGURIDAD Y RESTAURACIÓN -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-database me-2"></i> Base de Datos (Backup / Restaurar)</h5>
            </div>
            <div class="card-body">
                <h6>Descargar Copia</h6>
                <p class="small text-muted">Descarga una copia completa (.bak) de la base de datos actual.</p>
                <a href="{{ url_for('backup_db') }}" class="btn btn-warning w-100 mb-4">
                    <i class="fas fa-download me-2"></i> Descargar Copia de Seguridad
                </a>
                
                <hr>
                
                <h6 class="text-danger">Restaurar Copia de Seguridad</h6>
                <p class="small text-danger"><strong>¡ADVERTENCIA!</strong> Esta acción borrará TODOS los datos actuales y los sustituirá por los del archivo seleccionado. No se puede deshacer.</p>
                
                <form action="{{ url_for('restore_db') }}" method="POST" enctype="multipart/form-data" onsubmit="return confirm('PELIGRO CRÍTICO: \n\nEsta acción borrará PERMANENTEMENTE toda la información actual (Inventario, OTs, Usuarios, etc.) y la reemplazará con los datos del archivo subido.\n\n¿Estás absolutamente seguro de continuar?');">
                    <div class="mb-3">
                        <label for="db_file" class="form-label">Seleccionar archivo (.bak, .db)</label>
                        <input class="form-control" type="file" id="db_file" name="db_file" accept=".db,.bak,.sqlite,.sqlite3" required>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-upload me-2"></i> Restaurar Base de Datos
                    </button>
                </form>
            </div>
        </div>
        <!-- FIN BLOQUE ACTUALIZADO -->
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Registro de Actividad (Logging)</h5>
            </div>
            <div class="card-body">
                <p>Activa el sistema de logging para registrar operaciones críticas.</p>
                <form action="{{ url_for('toggle_logging') }}" method="POST" class="mb-3">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="loggingSwitch" name="logging_enabled" onchange="this.form.submit()" {{ 'checked' if logging_enabled else '' }}>
                        <label class="form-check-label" for="loggingSwitch"><strong>{{ 'Sistema de Logging ACTIVADO' if logging_enabled else 'Sistema de Logging DESACTIVADO' }}</strong></label>
                    </div>
                </form>
                <div class="d-flex justify-content-between align-items-center p-3 border rounded bg-light">
                    <div>
                        <strong>Archivo:</strong> <code>gmao_app.log</code><br>
                        <small class="text-muted">Tamaño: {{ log_size }}</small>
                    </div>
                    <a href="{{ url_for('download_log') }}" class="btn btn-primary {{ 'disabled' if log_size == '0 KB' else '' }}">
                        <i class="fas fa-download me-2"></i> Descargar
                    </a>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i> Gestión de Usuarios</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">+ Nuevo Usuario</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.rol }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editUserModal{{ user.id }}"><i class="fas fa-edit"></i></button>
                                {% if user.username != 'Administrador' %}
                                <form action="{{ url_for('delete_user', id=user.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Borrar usuario?');">
                                    <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>
                                </form>
                                {% endif %}
                                <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form action="{{ url_for('edit_user', id=user.id) }}" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Editar Usuario</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Contraseña (dejar en blanco para no cambiar)</label>
                                                        <input type="password" class="form-control" name="password">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Rol</label>
                                                        <input type="text" class="form-control" name="rol" value="{{ user.rol }}">
                                                    </div>
                                                    <h6>Permisos</h6>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="perm_inventario" {{ 'checked' if user.perm_inventario else '' }}>
                                                        <label class="form-check-label">Inventario</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="perm_actividades" {{ 'checked' if user.perm_actividades else '' }}>
                                                        <label class="form-check-label">Actividades</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="perm_configuracion" {{ 'checked' if user.perm_configuracion else '' }}>
                                                        <label class="form-check-label">Configuración Global</label>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tags me-2"></i> Gestión de Tipos de Equipo</span>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTypeConfigModal">+ Nuevo Tipo</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tipo in tipos %}
                        <tr>
                            <td>{{ tipo.id }}</td>
                            <td>{{ tipo.nombre }}</td>
                            <td><a href="{{ url_for('edit_type', id=tipo.id) }}" class="btn btn-sm btn-outline-primary">Editar</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center">No hay tipos definidos.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_user') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <input type="text" class="form-control" name="rol" value="Usuario">
                    </div>
                    <h6>Permisos</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_inventario">
                        <label class="form-check-label">Inventario</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_actividades">
                        <label class="form-check-label">Actividades</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_configuracion">
                        <label class="form-check-label">Configuración Global</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Crear</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addTypeConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_type_config') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Tipo de Equipo</h5>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" name="nombre" placeholder="Ej: Vehículos" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\settings\index.html ---

--- INICIO ARCHIVO: templates\work_orders\cronograma.html ---
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Cronogramas de Ordenes de Trabajo {{ year }}</h1>
    <div class="d-flex align-items-center gap-3">
        <form action="{{ url_for('cronograma') }}" method="GET" class="d-flex align-items-center">
            <label for="yearSelect" class="me-2 fw-bold">Año:</label>
            <input type="number" id="yearSelect" name="year" class="form-control" value="{{ year }}" style="width: 100px;" onchange="this.form.submit()">
            <button type="submit" class="btn btn-primary btn-sm ms-2">Ir</button>
        </form>
        <a href="{{ url_for('print_cronograma', year=year) }}" target="_blank" class="btn btn-secondary">
            <i class="fas fa-print"></i> Imprimir PDF
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-sm text-center">
        <!-- Sin 'table-dark' para que use el estilo forzado claro de base.html -->
        <thead>
            <tr>
                <th style="width: 200px;">Actividad / Equipo</th>
                {% for m in meses %}
                <th>{{ m }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                <!-- Celda lateral con clase cron-sidebar-col (texto oscuro y fondo claro forzado) -->
                <td class="text-start cron-sidebar-col fw-bold">
                    {{ row.actividad }}<br>
                    <small class="text-muted">{{ row.equipo }}</small>
                </td>
                {% for month_idx in range(1, 13) %}
                <td style="vertical-align: top;">
                    {% if month_idx in row.ots %}
                        {% for ot in row.ots[month_idx] %}
                        <div class="badge-status {% if ot.estado == 'Realizada' %}status-realizada{% elif ot.estado == 'En curso' %}status-en-curso{% elif ot.estado == 'Pendiente' %}status-pendiente{% elif ot.estado == 'Prevista' %}status-prevista{% elif ot.estado == 'Aplazada' %}status-aplazada{% else %}status-rechazada{% endif %}" 
                             title="{{ ot.nombre }} ({{ ot.fecha }})" 
                             data-bs-toggle="modal" 
                             data-bs-target="#cronModalOT{{ ot.id }}">
                            {{ ot.day_day }}
                        </div>
                        
                        <!-- Modal de Edición Rápida -->
                        <div class="modal fade text-start" id="cronModalOT{{ ot.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{{ url_for('update_ot', id=ot.id) }}" method="POST">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ ot.nombre }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" name="redirect_to" value="cronograma">
                                            <input type="hidden" name="cronograma_year" value="{{ year }}"> <!-- AÑADIDO: Mantiene el año actual -->
                                            <div class="alert alert-secondary">
                                                <strong>Operaciones:</strong><br>{{ ot.operaciones }}
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Estado</label>
                                                <select class="form-select" name="estado">
                                                    <option value="En curso" {{ 'selected' if ot.estado == 'En curso' }}>En curso</option>
                                                    <option value="Pendiente" {{ 'selected' if ot.estado == 'Pendiente' }}>Pendiente</option>
                                                    <option value="Prevista" {{ 'selected' if ot.estado == 'Prevista' }}>Prevista</option>
                                                    <option value="Realizada" {{ 'selected' if ot.estado == 'Realizada' }}>Realizada</option>
                                                    <option value="Aplazada" {{ 'selected' if ot.estado == 'Aplazada' }}>Aplazada</option>
                                                    <option value="Rechazada" {{ 'selected' if ot.estado == 'Rechazada' }}>Rechazada</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Observaciones</label>
                                                <textarea class="form-control" name="observaciones">{{ ot.observaciones or '' }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Fecha Realización</label>
                                                <input type="date" class="form-control" name="fecha_realizada" value="{{ ot.fecha_realizada or '' }}">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Actualizar OT</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3">
    <small>Leyenda: 
        <span class="badge status-realizada">Realizada</span> 
        <span class="badge status-en-curso">En Curso</span> 
        <span class="badge status-pendiente">Pendiente</span> 
        <span class="badge status-prevista">Prevista</span> 
        <span class="badge status-aplazada">Aplazada</span> 
        <span class="badge status-rechazada">Rechazada</span>. 
        El número indica el día del mes. Haz click para editar.
    </small>
</div>
{% endblock %}
--- FIN ARCHIVO: templates\work_orders\cronograma.html ---

--- INICIO ARCHIVO: templates\work_orders\index.html ---
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Órdenes de Trabajo</h1>
    <div class="d-flex gap-2">
        <form action="{{ url_for('generate_work_orders') }}" method="POST">
            <button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt"></i> Generar OTs</button>
        </form>
        <a href="{{ url_for('print_all_ots') }}" class="btn btn-secondary" target="_blank"><i class="fas fa-print"></i>
            Imprimir Todo</a>

    </div>
</div>

<!-- Date Filter Row -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="min" class="form-label">Fecha Desde:</label>
                <input type="date" id="min" name="min" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="max" class="form-label">Fecha Hasta:</label>
                <input type="date" id="max" name="max" class="form-control">
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle datatable" id="tablaOTs">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>ID</th>
                <th>Nombre OT</th>
                <th>Equipo</th>
                <th>Fecha Gen.</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for ot in ots %}
            <tr>
                <td></td>
                <td>{{ ot.id }}</td>
                <td>{{ ot.nombre }}</td>
                <td>{{ ot.equipo_nombre }}</td>
                <td>{{ ot.fecha_generacion }}</td>
                <td>
                    {% if ot.estado == 'Realizada' %}<span class="badge status-realizada">Realizada</span>
                    {% elif ot.estado == 'En curso' %}<span class="badge status-en-curso">En curso</span>
                    {% elif ot.estado == 'Pendiente' %}<span class="badge status-pendiente">Pendiente</span>
                    {% elif ot.estado == 'Prevista' %}<span class="badge status-prevista">Prevista</span>
                    {% elif ot.estado == 'Aplazada' %}<span class="badge status-aplazada">Aplazada</span>
                    {% else %}<span class="badge status-rechazada">Rechazada</span>{% endif %}
                </td>
                <td>
                    <a href="{{ url_for('print_ot', id=ot.id) }}" class="btn btn-sm btn-secondary" target="_blank"><i
                            class="fas fa-print"></i></a>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                        data-bs-target="#modalOT{{ ot.id }}">Gestionar</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for ot in ots %}
<div class="modal fade" id="modalOT{{ ot.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('update_ot', id=ot.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">{{ ot.nombre }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-secondary"><strong>Operaciones:</strong><br>{{ ot.operaciones }}</div>
                    <div class="mb-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="estado">
                            <option value="En curso" {{ 'selected' if ot.estado=='En curso' }}>En curso</option>
                            <option value="Pendiente" {{ 'selected' if ot.estado=='Pendiente' }}>Pendiente</option>
                            <option value="Prevista" {{ 'selected' if ot.estado=='Prevista' }}>Prevista</option>
                            <option value="Realizada" {{ 'selected' if ot.estado=='Realizada' }}>Realizada</option>
                            <option value="Aplazada" {{ 'selected' if ot.estado=='Aplazada' }}>Aplazada</option>
                            <option value="Rechazada" {{ 'selected' if ot.estado=='Rechazada' }}>Rechazada</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones">{{ ot.observaciones }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha Realización</label>
                        <input type="date" class="form-control" name="fecha_realizada" value="{{ ot.fecha_realizada }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Actualizar OT</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        // Restaurar filtros de fecha desde localStorage
        var savedMin = localStorage.getItem('ot_min_date');
        var savedMax = localStorage.getItem('ot_max_date');

        if (savedMin) $('#min').val(savedMin);
        if (savedMax) $('#max').val(savedMax);

        // Clear any existing search functions to avoid stacking on reloads if not full reload
        $.fn.dataTable.ext.search = [];

        // Custom filtering function which will search data in column four between two values
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                // Check if this is the correct table (optional, but good if multiple tables exist)
                if (settings.nTable.id !== 'tablaOTs') {
                    return true;
                }

                var min = $('#min').val();
                var max = $('#max').val();
                var date = data[4]; // Index 4 is Fecha Gen. (YYYY-MM-DD) - Remember index shifted by checkbox

                if (
                    (min === "" || min === null) && (max === "" || max === null) ||
                    (min === "" || min === null) && date <= max ||
                    (min <= date) && (max === "" || max === null) ||
                    (min <= date && date <= max)
                ) {
                    return true;
                }
                return false;
            }
        );

        // Event listener to the two range filtering inputs to redraw on input
        $('#min, #max').on('change', function () {
            // Guardar en localStorage
            localStorage.setItem('ot_min_date', $('#min').val());
            localStorage.setItem('ot_max_date', $('#max').val());
            $('#tablaOTs').DataTable().draw();
        });

        // Force draw if filters exist
        if (savedMin || savedMax) {
            setTimeout(function () {
                $('#tablaOTs').DataTable().draw();
            }, 100);
        }
    });
</script>
{% endblock %}
--- FIN ARCHIVO: templates\work_orders\index.html ---

