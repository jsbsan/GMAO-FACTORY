{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4"><h1 class="h2">Correctivos e Incidencias</h1><div><button class="btn btn-primary btn-sm me-2" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevoCorrectivo"><i class="fas fa-plus"></i> Nueva Incidencia</button><a href="{{ url_for('print_all_correctivos', f_nombre=f_nombre, f_equipo=f_equipo, f_estado=f_estado, f_fecha_desde=f_fecha_desde, f_fecha_hasta=f_fecha_hasta) }}" class="btn btn-secondary btn-sm" target="_blank"><i class="fas fa-print"></i> Imprimir Tabla</a></div></div>
<div class="collapse mb-4" id="formNuevoCorrectivo"><div class="card card-body bg-light"><h5 class="card-title mb-3">Registrar Nueva Incidencia</h5><form action="{{ url_for('add_correctivo') }}" method="POST" enctype="multipart/form-data" class="row g-3"><div class="col-md-6"><label class="form-label">Nombre del Correctivo</label><input type="text" class="form-control" name="nombre" required></div><div class="col-md-6"><label class="form-label">Equipo Afectado</label><select class="form-select" name="equipo_id" required>{% for eq in equipos %}<option value="{{ eq.id }}">{{ eq.nombre }} ({{ eq.tipo_nombre }})</option>{% endfor %}</select></div><div class="col-12"><label class="form-label">Comentario</label><textarea class="form-control" name="comentario" rows="2"></textarea></div><div class="col-md-3"><label class="form-label">Fecha Detectada</label><input type="date" class="form-control" name="fecha_detectada" value="{{ system_date }}" required></div><div class="col-md-3"><label class="form-label">Estado Inicial</label><select class="form-select" name="estado"><option value="Detectada">Detectada</option><option value="En curso">En curso</option><option value="Resuelta">Resuelta</option></select></div><div class="col-md-3"><label class="form-label">Imágenes</label><input type="file" class="form-control" name="images" multiple accept="image/*"></div><div class="col-md-3"><label class="form-label">PDFs</label><input type="file" class="form-control" name="pdfs" multiple accept="application/pdf"></div><div class="col-12 text-end"><button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#formNuevoCorrectivo">Cancelar</button><button type="submit" class="btn btn-danger">Guardar Incidencia</button></div></form></div></div>
<div class="card mb-3"><div class="card-body py-3"><form action="{{ url_for('correctivos') }}" method="GET" class="row g-2 align-items-end"><div class="col-md-3"><label class="form-label small mb-1">Nombre</label><input type="text" class="form-control form-control-sm" name="f_nombre" value="{{ f_nombre }}" placeholder="Buscar..."></div><div class="col-md-2"><label class="form-label small mb-1">Equipo</label><select class="form-select form-select-sm" name="f_equipo"><option value="">Todos</option>{% for eq in equipos %}<option value="{{ eq.id }}" {{ 'selected' if f_equipo|string == eq.id|string }}>{{ eq.nombre }}</option>{% endfor %}</select></div><div class="col-md-2"><label class="form-label small mb-1">Estado</label><select class="form-select form-select-sm" name="f_estado"><option value="">Todos</option><option value="Detectada" {{ 'selected' if f_estado == 'Detectada' }}>Detectada</option><option value="En curso" {{ 'selected' if f_estado == 'En curso' }}>En curso</option><option value="Resuelta" {{ 'selected' if f_estado == 'Resuelta' }}>Resuelta</option></select></div><div class="col-md-2"><label class="form-label small mb-1">Desde</label><input type="date" class="form-control form-control-sm" name="f_fecha_desde" value="{{ f_fecha_desde }}"></div><div class="col-md-2 d-flex gap-2"><button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-filter"></i></button><a href="{{ url_for('correctivos') }}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-times"></i></a></div></form></div></div>
<div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-dark"><tr><th>ID</th><th>Incidencia</th><th>Equipo</th><th>Estado</th><th>Detectada</th><th>Resolución</th><th>Archivos</th><th>Acciones</th></tr></thead><tbody>{% for c in correctivos %}<tr><td>{{ c.id }}</td><td>{{ c.nombre }}</td><td>{{ c.equipo_nombre }}</td><td>{% if c.estado == 'Detectada' %}<span class="badge corr-detectada">Detectada</span>{% elif c.estado == 'En curso' %}<span class="badge corr-en-curso">En curso</span>{% elif c.estado == 'Resuelta' %}<span class="badge corr-resuelta">Resuelta</span>{% endif %}</td><td>{{ c.fecha_detectada }}</td><td>{{ c.fecha_resolucion or '-' }}</td><td>{% set imgs = c.images|json_load %}{% set pdfs = c.pdfs|json_load %}{% if imgs or pdfs %}<span class="badge bg-secondary">{{ imgs|length }} <i class="fas fa-image"></i></span> <span class="badge bg-secondary">{{ pdfs|length }} <i class="fas fa-file-pdf"></i></span>{% else %}-{% endif %}</td><td><a href="{{ url_for('print_correctivo', id=c.id) }}" class="btn btn-sm btn-secondary" target="_blank"><i class="fas fa-print"></i></a> <a href="{{ url_for('edit_correctivo', id=c.id) }}" class="btn btn-sm btn-warning"><i class="fas fa-edit"></i></a> <form action="{{ url_for('delete_correctivo', id=c.id) }}" method="POST" class="d-inline" onsubmit="return confirm('¿Borrar?');"><button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button></form></td></tr>{% endfor %}</tbody></table></div>
<nav><ul class="pagination justify-content-center">{% if page > 1 %}<li class="page-item"><a class="page-link" href="{{ url_for('correctivos', page=page-1, f_nombre=f_nombre, f_equipo=f_equipo, f_estado=f_estado, f_fecha_desde=f_fecha_desde) }}">Anterior</a></li>{% endif %}<li class="page-item disabled"><span class="page-link">Página {{ page }}</span></li>{% if has_next %}<li class="page-item"><a class="page-link" href="{{ url_for('correctivos', page=page+1, f_nombre=f_nombre, f_equipo=f_equipo, f_estado=f_estado, f_fecha_desde=f_fecha_desde) }}">Siguiente</a></li>{% endif %}</ul></nav>
<script>function verGaleria(source, tipo, id) {window.location.href = "/view_files/" + source + "/" + tipo + "/" + id;}</script>
{% endblock %}