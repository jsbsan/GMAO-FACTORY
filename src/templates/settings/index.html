{% extends "base.html" %}
{% block content %}
<h1 class="h2 mb-4">Configuración Global</h1>

<!-- NUEVO PANEL: IDENTIDAD DEL SITIO (Encima de todo) -->
<div class="row">
    <div class="col-12">
        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-id-card me-2"></i> Identidad del Sitio</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('update_maintenance_name') }}" method="POST" class="row align-items-end">
                    <div class="col-md-10">
                        <label class="form-label">Nombre del Mantenimiento</label>
                        <input type="text" class="form-control form-control-lg" name="nombre_mantenimiento"
                            value="{{ maintenance_name }}" placeholder="Ej: GMAO Planta Principal" required>
                        <div class="form-text">Este nombre aparecerá en la barra lateral y en el menú superior.</div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100 btn-lg">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Fecha del Sistema</h5>
            </div>
            <div class="card-body">
                <p>Define la fecha con la que opera el sistema para simulaciones o ajustes temporales.</p>
                <form action="{{ url_for('update_system_date') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Fecha Actual del Sistema</label>
                        <input type="date" class="form-control" name="fecha_sistema" value="{{ system_date }}" required>
                        <div class="form-text">Todas las operaciones automáticas usarán esta fecha.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Actualizar Fecha</button>
                </form>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i> Planificación Futura</h5>
            </div>
            <div class="card-body">
                <p>Generar órdenes de trabajo "Previstas" (Grises) desde mañana hasta una fecha futura.</p>
                <form action="{{ url_for('update_planned_date') }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Fecha Prevista (Límite)</label>
                        <input type="date" class="form-control" name="fecha_prevista" value="{{ planned_date or '' }}"
                            required>
                        <div class="form-text">Debe ser posterior a la fecha del sistema.</div>
                    </div>
                    <button type="submit" class="btn btn-success">Actualizar y Generar</button>
                </form>
            </div>
        </div>
        <!-- BLOQUE ACTUALIZADO: COPIA DE SEGURIDAD Y RESTAURACIÓN -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-database me-2"></i> Base de Datos (Backup / Restaurar)</h5>
            </div>
            <div class="card-body">
                <h6>Descargar Copia</h6>
                <p class="small text-muted">Descarga una copia completa (.bak) de la base de datos actual.</p>
                <a href="{{ url_for('backup_db') }}" class="btn btn-warning w-100 mb-4">
                    <i class="fas fa-download me-2"></i> Descargar Copia de Seguridad
                </a>

                <hr>

                <h6 class="text-danger">Restaurar Copia de Seguridad</h6>
                <p class="small text-danger"><strong>¡ADVERTENCIA!</strong> Esta acción borrará TODOS los datos actuales
                    y los sustituirá por los del archivo seleccionado. No se puede deshacer.</p>

                <form action="{{ url_for('restore_db') }}" method="POST" enctype="multipart/form-data"
                    onsubmit="return confirm('PELIGRO CRÍTICO: \n\nEsta acción borrará PERMANENTEMENTE toda la información actual (Inventario, OTs, Usuarios, etc.) y la reemplazará con los datos del archivo subido.\n\n¿Estás absolutamente seguro de continuar?');">
                    <div class="mb-3">
                        <label for="db_file" class="form-label">Seleccionar archivo (.bak, .db)</label>
                        <input class="form-control" type="file" id="db_file" name="db_file"
                            accept=".db,.bak,.sqlite,.sqlite3" required>
                    </div>
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="fas fa-upload me-2"></i> Restaurar Base de Datos
                    </button>
                </form>
            </div>
        </div>
        <!-- FIN BLOQUE ACTUALIZADO -->
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i> Registro de Actividad (Logging)</h5>
            </div>
            <div class="card-body">
                <p>Activa el sistema de logging para registrar operaciones críticas.</p>
                <form action="{{ url_for('toggle_logging') }}" method="POST" class="mb-3">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" role="switch" id="loggingSwitch"
                            name="logging_enabled" onchange="this.form.submit()" {{ 'checked' if logging_enabled else ''
                            }}>
                        <label class="form-check-label" for="loggingSwitch"><strong>{{ 'Sistema de Logging ACTIVADO' if
                                logging_enabled else 'Sistema de Logging DESACTIVADO' }}</strong></label>
                    </div>
                </form>
                <div class="d-flex justify-content-between align-items-center p-3 border rounded bg-light">
                    <div>
                        <strong>Archivo:</strong> <code>gmao_app.log</code><br>
                        <small class="text-muted">Tamaño: {{ log_size }}</small>
                    </div>
                    <a href="{{ url_for('download_log') }}"
                        class="btn btn-primary {{ 'disabled' if log_size == '0 KB' else '' }}">
                        <i class="fas fa-download me-2"></i> Descargar
                    </a>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i> Gestión de Usuarios</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">+ Nuevo
                    Usuario</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.rol }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" data-bs-toggle="modal"
                                    data-bs-target="#editUserModal{{ user.id }}"><i class="fas fa-edit"></i></button>
                                {% if user.username != 'Administrador' %}
                                <form action="{{ url_for('delete_user', id=user.id) }}" method="POST" class="d-inline"
                                    onsubmit="return confirm('¿Borrar usuario?');">
                                    <button type="submit" class="btn btn-sm btn-danger"><i
                                            class="fas fa-trash"></i></button>
                                </form>
                                {% endif %}
                                <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form action="{{ url_for('edit_user', id=user.id) }}" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Editar Usuario</h5>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Contraseña (dejar en blanco para no
                                                            cambiar)</label>
                                                        <input type="password" class="form-control" name="password">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Rol</label>
                                                        <input type="text" class="form-control" name="rol"
                                                            value="{{ user.rol }}">
                                                    </div>
                                                    <h6>Permisos</h6>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="perm_inventario" {{ 'checked' if user.perm_inventario
                                                            else '' }}>
                                                        <label class="form-check-label">Inventario</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="perm_actividades" {{ 'checked' if
                                                            user.perm_actividades else '' }}>
                                                        <label class="form-check-label">Actividades</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="perm_configuracion" {{ 'checked' if
                                                            user.perm_configuracion else '' }}>
                                                        <label class="form-check-label">Configuración Global</label>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-primary">Guardar
                                                        Cambios</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tags me-2"></i> Gestión de Tipos de Equipo</span>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTypeConfigModal">+
                    Nuevo Tipo</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tipo in tipos %}
                        <tr>
                            <td>{{ tipo.id }}</td>
                            <td>{{ tipo.nombre }}</td>
                            <td><a href="{{ url_for('edit_type', id=tipo.id) }}"
                                    class="btn btn-sm btn-outline-primary">Editar</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center">No hay tipos definidos.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_user') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Usuario</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rol</label>
                        <input type="text" class="form-control" name="rol" value="Usuario">
                    </div>
                    <h6>Permisos</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_inventario">
                        <label class="form-check-label">Inventario</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_actividades">
                        <label class="form-check-label">Actividades</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="perm_configuracion">
                        <label class="form-check-label">Configuración Global</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Crear</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="addTypeConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_type_config') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Tipo de Equipo</h5>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" name="nombre" placeholder="Ej: Vehículos" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}