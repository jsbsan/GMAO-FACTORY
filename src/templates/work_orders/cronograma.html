{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Cronogramas de Ordenes de Trabajo {{ year }}</h1>
    <div class="d-flex align-items-center gap-3">
        <form action="{{ url_for('cronograma') }}" method="GET" class="d-flex align-items-center">
            <label for="yearSelect" class="me-2 fw-bold">Año:</label>
            <input type="number" id="yearSelect" name="year" class="form-control" value="{{ year }}" style="width: 100px;" onchange="this.form.submit()">
            <button type="submit" class="btn btn-primary btn-sm ms-2">Ir</button>
        </form>
        <a href="{{ url_for('print_cronograma', year=year) }}" target="_blank" class="btn btn-secondary">
            <i class="fas fa-print"></i> Imprimir PDF
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-sm text-center">
        <!-- Sin 'table-dark' para que use el estilo forzado claro de base.html -->
        <thead>
            <tr>
                <th style="width: 200px;">Actividad / Equipo</th>
                {% for m in meses %}
                <th>{{ m }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr>
                <!-- Celda lateral con clase cron-sidebar-col (texto oscuro y fondo claro forzado) -->
                <td class="text-start cron-sidebar-col fw-bold">
                    {{ row.actividad }}<br>
                    <small class="text-muted">{{ row.equipo }}</small>
                </td>
                {% for month_idx in range(1, 13) %}
                <td style="vertical-align: top;">
                    {% if month_idx in row.ots %}
                        {% for ot in row.ots[month_idx] %}
                        <div class="badge-status {% if ot.estado == 'Realizada' %}status-realizada{% elif ot.estado == 'En curso' %}status-en-curso{% elif ot.estado == 'Pendiente' %}status-pendiente{% elif ot.estado == 'Prevista' %}status-prevista{% elif ot.estado == 'Aplazada' %}status-aplazada{% else %}status-rechazada{% endif %}" 
                             title="{{ ot.nombre }} ({{ ot.fecha }})" 
                             data-bs-toggle="modal" 
                             data-bs-target="#cronModalOT{{ ot.id }}">
                            {{ ot.day_day }}
                        </div>
                        
                        <!-- Modal de Edición Rápida -->
                        <div class="modal fade text-start" id="cronModalOT{{ ot.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <form action="{{ url_for('update_ot', id=ot.id) }}" method="POST">
                                        <div class="modal-header">
                                            <h5 class="modal-title">{{ ot.nombre }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <input type="hidden" name="redirect_to" value="cronograma">
                                            <input type="hidden" name="cronograma_year" value="{{ year }}"> <!-- AÑADIDO: Mantiene el año actual -->
                                            <div class="alert alert-secondary">
                                                <strong>Operaciones:</strong><br>{{ ot.operaciones }}
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Estado</label>
                                                <select class="form-select" name="estado">
                                                    <option value="En curso" {{ 'selected' if ot.estado == 'En curso' }}>En curso</option>
                                                    <option value="Pendiente" {{ 'selected' if ot.estado == 'Pendiente' }}>Pendiente</option>
                                                    <option value="Prevista" {{ 'selected' if ot.estado == 'Prevista' }}>Prevista</option>
                                                    <option value="Realizada" {{ 'selected' if ot.estado == 'Realizada' }}>Realizada</option>
                                                    <option value="Aplazada" {{ 'selected' if ot.estado == 'Aplazada' }}>Aplazada</option>
                                                    <option value="Rechazada" {{ 'selected' if ot.estado == 'Rechazada' }}>Rechazada</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Observaciones</label>
                                                <textarea class="form-control" name="observaciones">{{ ot.observaciones or '' }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Fecha Realización</label>
                                                <input type="date" class="form-control" name="fecha_realizada" value="{{ ot.fecha_realizada or '' }}">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Actualizar OT</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="mt-3">
    <small>Leyenda: 
        <span class="badge status-realizada">Realizada</span> 
        <span class="badge status-en-curso">En Curso</span> 
        <span class="badge status-pendiente">Pendiente</span> 
        <span class="badge status-prevista">Prevista</span> 
        <span class="badge status-aplazada">Aplazada</span> 
        <span class="badge status-rechazada">Rechazada</span>. 
        El número indica el día del mes. Haz click para editar.
    </small>
</div>
{% endblock %}