{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4"><h1 class="h2">Órdenes de Trabajo</h1><div class="d-flex gap-2"><a href="{{ url_for('print_all_ots', estado=estado_filter, fecha_inicio=fecha_inicio_filter, fecha_fin=fecha_fin_filter) }}" class="btn btn-secondary" target="_blank"><i class="fas fa-print"></i> Imprimir Tabla</a><form action="{{ url_for('generate_work_orders') }}" method="POST"><button type="submit" class="btn btn-warning"><i class="fas fa-sync-alt"></i> Generar OTs</button></form></div></div>
<div class="card mb-3"><div class="card-body"><form action="{{ url_for('work_orders') }}" method="GET" class="row g-3 align-items-end"><div class="col-md-3"><label class="form-label">Estado</label><select class="form-select" name="estado"><option value="">Todos</option><option value="En curso" {{ 'selected' if estado_filter == 'En curso' }}>En curso</option><option value="Pendiente" {{ 'selected' if estado_filter == 'Pendiente' }}>Pendiente</option><option value="Prevista" {{ 'selected' if estado_filter == 'Prevista' }}>Prevista</option><option value="Realizada" {{ 'selected' if estado_filter == 'Realizada' }}>Realizada</option><option value="Aplazada" {{ 'selected' if estado_filter == 'Aplazada' }}>Aplazada</option><option value="Rechazada" {{ 'selected' if estado_filter == 'Rechazada' }}>Rechazada</option></select></div><div class="col-md-3"><label class="form-label">Desde</label><input type="date" class="form-control" name="fecha_inicio" value="{{ fecha_inicio_filter }}"></div><div class="col-md-3"><label class="form-label">Hasta</label><input type="date" class="form-control" name="fecha_fin" value="{{ fecha_fin_filter }}"></div><div class="col-md-3"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter"></i> Filtrar</button></div></form></div></div>
<div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-dark"><tr><th>ID</th><th>Nombre OT</th><th>Equipo</th><th>Fecha Gen.</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>{% for ot in ots %}<tr><td>{{ ot.id }}</td><td>{{ ot.nombre }}</td><td>{{ ot.equipo_nombre }}</td><td>{{ ot.fecha_generacion }}</td><td>{% if ot.estado == 'Realizada' %}<span class="badge bg-success">Realizada</span>{% elif ot.estado == 'En curso' %}<span class="badge bg-warning text-dark">En curso</span>{% elif ot.estado == 'Pendiente' %}<span class="badge bg-danger">Pendiente</span>{% elif ot.estado == 'Prevista' %}<span class="badge bg-secondary">Prevista</span>{% elif ot.estado == 'Aplazada' %}<span class="badge status-aplazada">Aplazada</span>{% else %}<span class="badge bg-dark">Rechazada</span>{% endif %}</td><td><a href="{{ url_for('print_ot', id=ot.id) }}" class="btn btn-sm btn-secondary" target="_blank"><i class="fas fa-print"></i></a> <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalOT{{ ot.id }}">Gestionar</button></td></tr>
<div class="modal fade" id="modalOT{{ ot.id }}" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form action="{{ url_for('update_ot', id=ot.id) }}" method="POST"><div class="modal-header"><h5 class="modal-title">{{ ot.nombre }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="alert alert-secondary"><strong>Operaciones:</strong><br>{{ ot.operaciones }}</div><div class="mb-3"><label class="form-label">Estado</label><select class="form-select" name="estado"><option value="En curso" {{ 'selected' if ot.estado == 'En curso' }}>En curso</option><option value="Pendiente" {{ 'selected' if ot.estado == 'Pendiente' }}>Pendiente</option><option value="Prevista" {{ 'selected' if ot.estado == 'Prevista' }}>Prevista</option><option value="Realizada" {{ 'selected' if ot.estado == 'Realizada' }}>Realizada</option><option value="Aplazada" {{ 'selected' if ot.estado == 'Aplazada' }}>Aplazada</option><option value="Rechazada" {{ 'selected' if ot.estado == 'Rechazada' }}>Rechazada</option></select></div><div class="mb-3"><label class="form-label">Observaciones</label><textarea class="form-control" name="observaciones">{{ ot.observaciones }}</textarea></div><div class="mb-3"><label class="form-label">Fecha Realización</label><input type="date" class="form-control" name="fecha_realizada" value="{{ ot.fecha_realizada }}"></div></div><div class="modal-footer"><button type="submit" class="btn btn-primary">Actualizar OT</button></div></form></div></div></div>{% endfor %}</tbody></table></div>
<nav><ul class="pagination justify-content-center">{% if page > 1 %}<li class="page-item"><a class="page-link" href="{{ url_for('work_orders', page=page-1, estado=estado_filter, fecha_inicio=fecha_inicio_filter, fecha_fin=fecha_fin_filter) }}">Anterior</a></li>{% endif %}<li class="page-item disabled"><span class="page-link">Página {{ page }}</span></li>{% if has_next %}<li class="page-item"><a class="page-link" href="{{ url_for('work_orders', page=page+1, estado=estado_filter, fecha_inicio=fecha_inicio_filter, fecha_fin=fecha_fin_filter) }}">Siguiente</a></li>{% endif %}</ul></nav>
{% endblock %}